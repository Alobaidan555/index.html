<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  
  <script>
      // ğŸŸ¢ Ù‚ÙŠÙ… FirebaseConfig Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
      const firebaseConfig = {
          apiKey: "AIzaSyBJbUi4uSOwaBev2HpbTH0DOtaeqSGiUxg",
          authDomain: "project-2o25.firebaseapp.com",
          projectId: "project-2o25",
          storageBucket: "project-2o25.firebasestorage.app",
          messagingSenderId: "995772420566",
          appId: "1:995772420566:web:44b5b6059f1f86ab499477"
      };

      // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Version 8
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      
      // ØªØ¹Ø±ÙŠÙ Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      const COLLECTION_NAME = 'competition_data'; 
  </script>
  
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        * { box-sizing: border-box; }
        
        .container {
            flex: 1;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 30px 20px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .entity-selector { margin-bottom: 30px; }
        .entity-selector label { display: block; font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .entity-selector select { width: 100%; padding: 15px; font-size: 1em; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s; }
        .entity-selector select:focus { outline: none; border-color: #667eea; }
        
        .quick-access {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .access-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .access-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .access-card h3 { margin: 0 0 10px 0; font-size: 1.5em; }
        .access-card p { margin: 0; opacity: 0.9; }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary { background: #6c757d; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        
        .section-title { font-size: 2em; color: #333; margin: 0 0 20px 0; text-align: center; }
        
        .login-form { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; color: #333; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; font-size: 1em; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        
        .entity-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .section-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .section-card:hover { transform: scale(1.05); }
        .section-card h3 { font-size: 1.8em; margin: 0; }
        
        .quiz-list { display: grid; gap: 15px; }
        
        .quiz-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-right: 5px solid #667eea;
        }
        .quiz-item h4 { margin: 0 0 10px 0; color: #333; }
        
        .quiz-item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .leaderboard-table th { background: #667eea; color: white; padding: 15px; text-align: right; }
        .leaderboard-table td { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .leaderboard-table tr:nth-child(even) { background: #f8f9fa; }
        
        /* Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ */
        .wheel-container-new { position: relative; width: min(400px, 90vw); height: min(400px, 90vw); max-width: 500px; max-height: 500px; }
        .arrow-new { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: clamp(15px, 2vw, 20px) solid transparent; border-right: clamp(15px, 2vw, 20px) solid transparent; border-top: clamp(30px, 4vw, 40px) solid #e57373; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .center-circle-new { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: clamp(40px, 8vw, 60px); height: clamp(40px, 8vw, 60px); background: #ffffff; border-radius: 50%; border: 4px solid #64b5f6; z-index: 5; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        #wheelPage .main-card { display: flex; flex-direction: column; align-items: center; }
        .wheel-content-wrapper { display: flex; gap: 20px; flex-wrap: wrap; width: 100%; max-width: 900px; justify-content: center; align-items: flex-start; }
        .wheel-section-new { flex: 1.5; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-width: 0; }
        .sidebar-new { flex: 1; background: rgba(255,255,255,0.95); border-radius: 20px; padding: clamp(15px, 3vw, 25px); box-shadow: 0 8px 32px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden; min-width: 250px; height: 450px; }
        .names-textarea { flex: 1; min-height: 200px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: clamp(14px, 1.5vw, 16px); font-family: 'Arial', sans-serif; resize: none; transition: border-color 0.3s; line-height: 1.8; }
        .controls-new { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: center; width: 100%; max-width: 400px; }
        .spin-button-new { background: #66bb6a; color: white; border: none; padding: clamp(12px, 2vw, 18px) clamp(30px, 5vw, 50px); font-size: clamp(16px, 2.5vw, 24px); font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 15px rgba(102,187,106,0.4); transition: all 0.3s; width: 100%; }
        .spin-button-new:hover:not(:disabled) { background: #57a35b; transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 20px rgba(102,187,106,0.6); }
        .spin-button-new.spinning { animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .winner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box; }
        .winner-modal.show { display: flex; }
        .winner-content { background: white; padding: clamp(30px, 5vw, 50px); border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: bounce-in 0.5s; max-width: 90%; }
        @keyframes bounce-in { 0% { transform: scale(0); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .winner-name-new { font-size: clamp(28px, 6vw, 48px); color: #66bb6a; font-weight: bold; margin: 0 0 30px 0; animation: glow 1.5s infinite; word-break: break-word; }
        @keyframes glow { 0%, 100% { text-shadow: 0 0 10px rgba(102,187,106,0.5); } 50% { text-shadow: 0 0 20px rgba(102,187,106,0.8); } }
        .close-button { background: #64b5f6; color: white; border: none; padding: clamp(12px, 2vw, 15px) clamp(30px, 5vw, 40px); border-radius: 25px; font-size: clamp(14px, 2vw, 18px); cursor: pointer; transition: background 0.3s; }
        .delete-button-new { background: #e57373; color: white; border: none; padding: clamp(12px, 2vw, 15px) clamp(30px, 5vw, 40px); border-radius: 25px; font-size: clamp(14px, 2vw, 18px); cursor: pointer; transition: background 0.3s; }
        @media (max-width: 900px) { .wheel-content-wrapper { flex-direction: column; align-items: center; } .sidebar-new { order: 2; width: 100%; max-width: 400px; height: auto; } .wheel-section-new { order: 1; } .controls-new { width: 100%; max-width: 300px; } }

        .member-list { margin-top: 20px; }
        .member-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; display: none; }
        .toast.error { background: #dc3545; }
        .toast.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateX(-50%) translateY(-100%); } to { transform: translateX(-50%) translateY(0); } }
        
        .back-btn { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
        .back-btn:hover { background: #5a6268; }
        
        .hidden { display: none; }
        .question-item { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .answer-option { display: block; padding: 10px; margin: 5px 0; background: white; border: 2px solid #e0e0e0; border-radius: 5px; cursor: pointer; }
        .answer-option:hover { border-color: #667eea; }
        .answer-option input { margin-left: 10px; }
        
        .question-form { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e0e0e0; }
        .question-form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .remove-question-btn { background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        .copy-question-btn { background: #17a2b8; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 10px; }
        .answer-input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .answer-input-group input[type="text"] { flex: 1; }
        .remove-answer-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
        .add-answer-btn { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .question-type-selector { margin-bottom: 15px; }
        
        .entity-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0; }
        .entity-card h4 { margin: 0 0 10px 0; color: #333; }
        .entity-card-actions { margin-top: 15px; display: flex; gap: 10px; }
        .entity-card-actions button { flex: 1; }
        
        .stats-summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .stats-summary h5 { margin: 0 0 10px 0; color: #667eea; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti-piece { position: fixed; width: 10px; height: 10px; animation: confetti 3s linear; pointer-events: none; z-index: 1001; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚) Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
        .wheel-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; 
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        .wheel-modal-content {
            background: white; border-radius: 15px; padding: 30px; max-width: 90%; max-height: 90%; overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center;
        }
  </style>
 </head>
 <body>
  <div class="toast" id="toast"></div>
  <div class="container"><div id="homePage">
    <div class="header">
     <h1 id="mainTitle">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</h1>
     <p id="welcomeMessage">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</p>
    </div>
    <div class="main-card">
     <div class="entity-selector"><label for="entitySelect">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„:</label> <select id="entitySelect"> <option value="">-- Ø§Ø®ØªØ± Ø¬Ù‡Ø© --</option> </select>
     </div><button class="btn" id="enterEntityBtn" disabled> <span id="enterButtonText">Ø¯Ø®ÙˆÙ„</span> </button>
     <div style="text-align: center; margin: 20px 0;">
      <div style="border-top: 2px solid #e0e0e0; margin: 20px 0;"></div>
      <p style="color: #666;">Ø£Ùˆ</p>
     </div>
     <div class="quick-access" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
      <div class="access-card" onclick="showPublicQuizzes()">
       <h3>ğŸ¯</h3>
       <h3>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
       <p>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</p>
      </div>
      <div class="access-card" onclick="showWheelOfFortune()">
       <h3>ğŸ¡</h3>
       <h3>Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸</h3>
       <p>Ø¬Ø±Ø¨ Ø­Ø¸Ùƒ Ø§Ù„Ø¢Ù†</p>
      </div>
     </div>
     <div style="margin-top: 30px;"><button class="btn" id="superAdminBtn" onclick="showPage('superAdminLoginPage')"> <span id="adminButtonText">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span> </button>
</div>
     </div>
    </div>
   </div><div id="superAdminLoginPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goToHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
     <form class="login-form" id="superAdminLoginForm" onsubmit="loginSuperAdmin(event)">
      <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label> <input type="text" id="superAdminUsername" required>
      </div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label> <input type="password" id="superAdminPassword" required>
      </div><button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
     </form>
    </div>
   </div><div id="superAdminPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goToHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
     <div class="form-group"><label>Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø© Ø¬Ø¯ÙŠØ¯Ø©:</label> <input type="text" id="newEntityName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©">
     </div>
     <div class="form-group"><label>Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¯ÙŠØ±:</label> <input type="text" id="newEntityAdminUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
     </div>
     <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±:</label> <input type="password" id="newEntityAdminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
     </div><button class="btn btn-success" onclick="addNewEntity()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù‡Ø©</button>
     <div style="margin-top: 40px;">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;"><button class="btn btn-success" onclick="exportBackup()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button> <button class="btn" onclick="document.getElementById('importFileInput').click()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      </div><input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importBackup(event)">
     </div>
     <div style="margin-top: 40px;">
      <h3>Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</h3>
      <div id="entitiesList"></div>
     </div>
    </div>
   </div><div id="entityPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goToHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title" id="entityPageTitle"></h2>
     <div id="entityPageEnrollmentCard">
        </div>
     <div class="entity-sections">
      <div class="section-card" onclick="showQuizzesSection()">
       <h3>ğŸ¯</h3>
       <h3>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h3>
      </div>
      <div class="section-card" onclick="showEntityAdminLogin()">
       <h3>âš™ï¸</h3>
       <h3>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      </div>
     </div>
    </div>
   </div>
   <div id="studentEnrollmentFormPage" class="hidden">
        <div class="main-card">
            <button class="back-btn" id="enrollBackBtn" onclick="showEntityPage()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h2 class="section-title">ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <form class="login-form" id="studentEnrollmentForm" onsubmit="submitStudentEnrollment(event)">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="enroll_name" required>
                </div>
                <div class="form-group">
                    <label>Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                    <input type="text" id="enroll_student_phone">
                </div>
                <div class="form-group">
                    <label>Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                    <input type="text" id="enroll_parent_phone">
                </div>
                <button type="submit" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            </form>
            <div id="enrollmentStatusMessage" style="text-align: center; margin-top: 20px; color: #667eea; font-weight: bold;"></div>
        </div>
    </div>
    <div id="enrollmentSettingsPage" class="hidden">
        <div class="main-card">
            <button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°Ø§ØªÙŠ</h2>
            <p style="color: #666; margin-bottom: 20px;">Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©.</p>

            <div class="form-group" style="background: #e9ecef; padding: 15px; border-radius: 8px;">
                <label style="font-weight: bold; margin-bottom: 10px;">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
                <select id="enrollmentStatus" style="width: 100%;">
                    <option value="disabled">ØºÙŠØ± Ù…ÙØ¹Ù„</option>
                    <option value="enabled">Ù…ÙØ¹Ù„ - ÙŠØ­ØªØ§Ø¬ Ø§Ø¹ØªÙ…Ø§Ø¯</option>
                    <option value="auto">Ù…ÙØ¹Ù„ - ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ (Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ø§Ø¹ØªÙ…Ø§Ø¯)</option>
                </select>
                <p style="font-size: 0.8em; margin-top: 5px; color: #6c757d;">(Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ ÙŠØªØ·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙØµÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ø¯Ù†Ø§Ù‡)</p>
            </div>

            <h4 style="margin-top: 30px; margin-bottom: 15px;">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©:</h4>
            <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                <label style="flex: 1;">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <input type="checkbox" id="req_name" checked disabled style="width: auto;">
            </div>
            <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                <label style="flex: 1;">Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <input type="checkbox" id="req_student_phone" style="width: auto;">
            </div>
            <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                <label style="flex: 1;">Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                <input type="checkbox" id="req_parent_phone" style="width: auto;">
            </div>

            <div id="defaultClassSettings" class="form-group" style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                <label>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ (Auto-Enroll):</label>
                <select id="defaultClassSelect">
                    </select>
            </div>
            
            <button class="btn btn-success" onclick="saveEnrollmentSettings()" style="margin-top: 30px;">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>
   <div id="entityAdminLoginPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntity()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
     <form class="login-form" id="entityAdminLoginForm" onsubmit="loginEntityAdmin(event)">
      <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label> <input type="text" id="entityAdminUsername" required>
      </div>
      <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label> <input type="password" id="entityAdminPassword" required>
      </div><button type="submit" class="btn">Ø¯Ø®ÙˆÙ„</button>
     </form>
    </div>
   </div><div id="entityAdminPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntity()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù‡Ø©</h2>
     <p style="text-align: center; color: #666; margin-bottom: 20px;">Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong id="loggedInUserName"></strong> (<span id="userRole"></span>)</p>
     <div class="entity-sections">
      </div>
    </div>
   </div><div id="membersManagementPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
     <div class="form-group"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label> <input type="text" id="newMemberUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
     </div>
     <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label> <input type="password" id="newMemberPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
     </div><button class="btn btn-success" onclick="addMember()">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ</button>
     <div class="member-list" id="membersList"></div>
    </div>
   </div><div id="addQuizPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© / Ø§Ø®ØªØ¨Ø§Ø±</h2>
     <div class="form-group"><label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label> <input type="text" id="quizTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
     </div>
     <div class="form-group"><label>Ø§Ù„Ù†ÙˆØ¹:</label> <select id="quizType"> <option value="quiz">Ø§Ø®ØªØ¨Ø§Ø±</option> <option value="competition">Ù…Ø³Ø§Ø¨Ù‚Ø©</option> </select>
     </div>
     <div class="form-group"><label>Ø§Ù„Ø±Ø¤ÙŠØ©:</label> <select id="quizVisibility"> <option value="public">Ø¹Ø§Ù…</option> <option value="private">Ø®Ø§Øµ</option> </select>
     </div>
     
     <div class="form-group">
        <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ) - Ø§ØªØ±ÙƒÙ‡ 0 Ù„ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯:</label>
        <input type="number" id="quizTimer" placeholder="Ù…Ø«Ø§Ù„: 30" value="0">
     </div>
     <div class="form-group" style="display:flex; align-items:center; gap:10px; margin-top:10px;">
        <input type="checkbox" id="enableCertificate" style="width:auto;">
        <label for="enableCertificate" style="margin:0;">ØªÙ…ÙƒÙŠÙ† Ù…Ù†Ø­ Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù„Ù†Ø³Ø¨Ø© 50% ÙØ£ÙƒØ«Ø±)</label>
     </div>
     
     <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
      <h3 style="margin-top: 0;">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</h3>
        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
            <h4>ğŸ“š Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø±ÙŠØ¹</h4>
            <p style="font-size:0.9em;">Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ù…Ø³Ø§Ø¨Ù‚Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
            <div style="display:flex; gap:10px;">
                <input type="number" id="importCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©" style="width:100px; padding:5px;">
                <button class="btn" style="width:auto; background:#1976d2;" onclick="importRandomQuestions()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
            </div>
        </div>
      <div id="questionsContainer"></div><button class="btn btn-success" id="addQuestionBtn" onclick="addQuestionForm()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
     </div><button class="btn btn-success" id="saveQuizBtn" onclick="saveQuiz()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
    </div>
   </div><div id="myQuizzesPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
     <div id="adminQuizzesList"></div>
    </div>
   </div><div id="quizzesPage" class="hidden">
    <div class="main-card"><button class="back-btn" id="quizzesBackBtn" onclick="goBackToEntity()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>
     <div class="quiz-list" id="quizzesList"></div>
    </div>
   </div><div id="takeQuizPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToQuizzes()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title" id="quizTitle"></h2>
     <div class="form-group"><label>Ø§Ø³Ù…Ùƒ:</label> <input type="text" id="participantName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"> <button class="btn btn-success" id="startQuizBtn" style="margin-top: 15px;" onclick="startQuizQuestions()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
     </div>
     <div id="quizQuestionsContainer"></div>
    </div>
   </div><div id="leaderboardPage" class="hidden">
    <div class="main-card"><button class="back-btn" id="leaderboardBackBtn" onclick="goBackToQuizzes()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h2>
     <h3 id="leaderboardSubtitle" style="text-align:center; color:#667eea; margin-bottom:20px;"></h3>
     <table class="leaderboard-table" id="leaderboardTable">
      <thead>
       <tr>
        <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</th>
        <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
        <th>Ø§Ù„ÙˆÙ‚Øª (Ø«Ø§Ù†ÙŠØ©)</th>
       </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
     </table>
    </div>
   </div>
   
   <div id="wheelPage" class="hidden">
    <div class="main-card" style="min-height: 80vh;">
      <button class="back-btn" onclick="goToHome()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
      <h2 class="section-title">Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸</h2>
      
      <div class="wheel-content-wrapper">
        <section class="wheel-section-new">
          <div class="wheel-container-new">
            <div class="arrow-new" id="wheelArrow" style="border-top-color: #e57373;"></div>
            <canvas id="wheelCanvas" width="400" height="400" style="border-radius: 50%; border: 8px solid #ffffff; box-shadow: 0 0 30px rgba(0,0,0,0.3); width: 100%; height: 100%;"></canvas>
            <div class="center-circle-new"></div>
          </div>
          <div class="controls-new">
            <button class="spin-button-new" id="spinButton" style="background-color: #66bb6a;">
              Ø£Ø¯Ø± Ø§Ù„Ø¹Ø¬Ù„Ø©
            </button>
          </div>
        </section>
        <aside class="sidebar-new">
          <h2 class="sidebar-title">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</h2>
          <textarea class="names-textarea" id="namesTextarea" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ù…ØªØ¹Ø¯Ø¯Ø© (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±)
Ù…Ø«Ø§Ù„:
Ù…Ø­Ù…Ø¯
ÙØ§Ø·Ù…Ø©
Ø¹Ù„ÙŠ
Ù†ÙˆØ±"></textarea>
        </aside>
      </div>
      
    </div>
   </div>
   
   <div id="contestWheelModal" class="wheel-modal-overlay hidden" onclick="if(event.target.id === 'contestWheelModal') hideContestWheelModal()">
        <div class="wheel-modal-content" onclick="event.stopPropagation()">
            <h2 class="section-title">ğŸ¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹</h2>
            
            <div id="contestWheelControls" style="width: 100%; max-width: 400px; margin-bottom: 20px;">
                <textarea class="names-textarea" id="contestNamesTextarea" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±)
Ù…Ø«Ø§Ù„:
Ù…Ø­Ù…Ø¯
ÙØ§Ø·Ù…Ø©
Ø¹Ù„ÙŠ
Ù†ÙˆØ±" style="min-height: 100px; margin-bottom: 10px;"></textarea>
                <button class="btn btn-secondary" style="width: 100%;" onclick="updateContestWheelNames()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¬Ù„Ø©</button>
            </div>
            
            <div class="wheel-container-new" style="width: 300px; height: 300px;">
                <div class="arrow-new" style="border-top-color: #f5576c;"></div>
                <canvas id="contestWheelCanvas" width="300" height="300" style="border-radius: 50%; border: 6px solid #f0f0f0;"></canvas>
                <div class="center-circle-new" style="width: 35px; height: 35px;"></div>
            </div>
            <div class="controls-new" style="max-width: 300px;">
                <button class="spin-button-new" id="contestSpinButton" style="background-color: #f5576c; font-size: 1.2em;">
                    Ø£Ø¯Ø± Ø§Ù„Ø¹Ø¬Ù„Ø©
                </button>
                <button class="btn btn-secondary" onclick="hideContestWheelModal()" style="width: 100%; margin-top: 10px;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <h3 id="contestWinnerDisplay" style="margin-top: 20px; font-size: 1.5em; color: #667eea;"></h3>
        </div>
   </div>

   <div id="participantsDetailsPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToMyQuizzes()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title" id="participantsQuizTitle"></h2>
     <div id="participantsDetailsList"></div>
    </div>
   </div>
   
   <div id="celebration-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
      <div id="celebration-content" style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: popIn 0.5s ease-out;">
        <div id="celebration-emoji" style="font-size: 80px; margin-bottom: 20px;">ğŸ‰</div>
        <div id="celebration-message" style="font-size: 24px; font-weight: bold; margin-bottom: 20px;"></div>
        <button id="celebration-close" style="background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
    </div>
    
    <div class="winner-modal" id="winnerModal">
Â  Â <div class="winner-content">
Â  Â  <div class="winner-emoji">ğŸ‰</div>
Â  Â  <h2 class="winner-title" id="winnerMessage">Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ</h2>
Â  Â  <div class="winner-name-new" id="winnerName"></div>
Â  Â  <div class="modal-buttons"><button class="close-button" id="closeModal">Ø±Ø§Ø¦Ø¹!</button> <button class="delete-button-new" id="deleteWinner">Ø­Ø°Ù Ø§Ù„ÙØ§Ø¦Ø²</button></div>
Â  Â </div>
Â  </div>

    <div id="certificateManagementPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h2>
     <div class="form-group">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label>
        <select id="certQuizSelect" onchange="loadQuizCertSettings()"></select>
     </div>
     <div id="certSettingsArea" class="hidden">
         <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:</label>
            <input type="text" id="certTitleInput" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±">
         </div>
         <div class="form-group">
            <label>Ù†Øµ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (ÙŠØ¸Ù‡Ø± Ù‚Ø¨Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨):</label>
            <input type="text" id="certBodyInput" placeholder="Ù…Ø«Ø§Ù„: ØªØ´Ù‡Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø£Ù†">
         </div>
         <div class="form-group">
            <label>ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ø¹Ø±Ø¶ÙŠØ©):</label>
            <input type="file" id="certBgInput" accept="image/*" onchange="previewCertImage()">
            <p style="font-size: 0.8em; color: #666;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù‚Ø¯ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­ÙØ¸.</p>
            <div id="certImagePreview" style="margin-top: 10px; max-width: 200px; border: 1px solid #ccc;"></div>
         </div>
         <button class="btn btn-success" onclick="saveCertSettings()">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
     </div>
    </div>
   </div>

   <div id="classesManagementPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
     <button class="btn btn-warning" onclick="showPendingEnrollments()" style="margin-bottom: 20px;">
        ğŸ”” Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (<span id="pendingCount">0</span>)
    </button>
     <div class="form-group" style="display: flex; gap: 10px;">
        <input type="text" id="newClassName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex: 1;">
        <button class="btn btn-success" style="width: auto;" onclick="createNewClass()">+ Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
     </div>
     <div id="classesList" class="quiz-list"></div>
    </div>
   </div>

   <div id="pendingEnrollmentsPage" class="hidden">
        <div class="main-card">
            <button class="back-btn" onclick="showClassesManagement()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØµÙˆÙ„</button>
            <h2 class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
            <div id="pendingEnrollmentList">
                </div>
        </div>
    </div>

   <div id="classDetailsPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="showClassesManagement()">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙØµÙˆÙ„</button>
     <h2 class="section-title" id="currentClassName"></h2>
     <p id="classTeacherName" style="text-align: center; color: #666; margin-bottom: 20px;"></p>
     
     <div class="form-group" style="background: #f0f0f0; padding: 15px; border-radius: 10px;">
        <label>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" style="flex: 1;">
            <input type="text" id="newStudentPhone" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨" style="flex: 1;">
        </div>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newParentPhone" placeholder="Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" style="flex: 1;">
            <button class="btn btn-success" style="width: auto;" onclick="addStudentToClass()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
     </div>

     <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨:</h3>
     <div id="studentsList" class="member-list"></div>
    </div>
   </div>

   <div id="teacherClassViewPage" class="hidden">
    <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
     <h2 class="section-title" id="teacherClassName"></h2>
     <div class="entity-sections" style="grid-template-columns: 1fr;">
        <div class="section-card" onclick="openAttendanceHistory()">
            <h3>ğŸ“‹</h3>
            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ù„Ø­Ø¶ÙˆØ±)</h3>
        </div>
        <div id="teacherClassViewDetails">
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="teacherStudentCount">0</span></p>
            <h3 style="margin-bottom: 15px;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…:</h3>
            <div id="teacherStudentsList" class="member-list"></div>
        </div>
     </div>
    </div>
   </div>
   
   <div id="attendanceHistoryPage" class="hidden">
        <div class="main-card"><button class="back-btn" onclick="goBackToEntityAdmin()">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h2 class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Ø§Ù„Ø­Ø¶ÙˆØ±)</h2>
            <h3 id="historyClassName" style="text-align:center; color:#667eea; margin-bottom:20px;"></h3>
            
            <div id="attendanceSummary" class="stats-summary" style="margin-bottom: 30px;"></div>
            
            <h3 style="margin-bottom: 15px;">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:</h3>
            <div id="attendanceRecordsList" class="member-list"></div>
        </div>
   </div>
   
  </div>
  <script>
    // ----------------------------------------------------------------------------------
    // ğŸ†• Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø±Ø¨Ø· Ø¨Ù€ FIREBASE FIRESTORE
    // ----------------------------------------------------------------------------------
    window.dataSdk = {
        // 1. Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
        async get() {
            try {
                const snapshot = await db.collection(COLLECTION_NAME).get();
                const data = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    __backendId: doc.id, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙƒÙ€ __backendId
                    id: doc.data().id || doc.id // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù‚Ù„ 'id' Ø£Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯
                }));
                return { isOk: true, data: data };
            } catch (error) {
                console.error("Firebase GET failed:", error);
                return { isOk: false, error: error };
            }
        },
        
        // 2. Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø¬Ù‡Ø© Ø£Ùˆ Ù†ØªÙŠØ¬Ø©)
        async create(data) {
            try {
                // Ø­Ø°Ù Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù€ Mock Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const dataToSave = { ...data };
                delete dataToSave.__backendId; 
                
                const docRef = await db.collection(COLLECTION_NAME).add(dataToSave);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Firestore ID)
                await docRef.update({ id: docRef.id });

                return { isOk: true, result: { __backendId: docRef.id } };
            } catch (error) {
                console.error("Firebase CREATE failed:", error);
                return { isOk: false, error: error };
            }
        },

        // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ«: ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯
        async update(data) {
            if (!data.__backendId) return { isOk: false, error: "Missing __backendId" };
            try {
                const docId = data.__backendId;
                // Ø­Ø°Ù Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù€ Mock Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const dataToUpdate = { ...data };
                delete dataToUpdate.__backendId;
                
                await db.collection(COLLECTION_NAME).doc(docId).update(dataToUpdate);
                return { isOk: true };
            } catch (error) {
                console.error("Firebase UPDATE failed:", error);
                return { isOk: false, error: error };
            }
        },
        
        // 4. Ø§Ù„Ø­Ø°Ù: Ø­Ø°Ù Ø³Ø¬Ù„
        async delete(data) {
            if (!data.__backendId) return { isOk: false, error: "Missing __backendId" };
            try {
                await db.collection(COLLECTION_NAME).doc(data.__backendId).delete();
                return { isOk: true };
            } catch (error) {
                console.error("Firebase DELETE failed:", error);
                return { isOk: false, error: error };
            }
        },
        
        // 5. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (ØªØ³ØªØ®Ø¯Ù… Ù„Ø±Ø¨Ø· dataHandler Ø¨Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØªÙˆÙÙŠØ± Realtime): 
        async init(dataHandler) {
            try {
                // Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ù€ Firebase Ø¨ØªØ­Ø¯ÙŠØ« dataHandler Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª (Realtime)
                db.collection(COLLECTION_NAME).onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({
                        ...doc.data(),
                        __backendId: doc.id,
                        id: doc.data().id || doc.id
                    }));
                    dataHandler.onDataChanged(data);
                });
                return { isOk: true };
            } catch (error) {
                console.error("Firebase INIT failed:", error);
                return { isOk: false, error: error };
            }
        }
    };
    // ----------------------------------------------------------------------------------
    // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    // ----------------------------------------------------------------------------------
        const MASTER_USERNAME = 'admin';
        const MASTER_PASSWORD = 'master123';
        
        let allData = [];
        let currentEntityId = null;
        let currentUserId = null;
        let currentUserRole = null;
        let currentQuizId = null;
        let quizStartTime = null;
        let isSuperAdmin = false;
        
        // ğŸ†• Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙ‚ÙŠØª
        let quizTimerInterval; 
        
        const defaultConfig = {
            main_title: 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ',
            welcome_message: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª',
            enter_button: 'Ø¯Ø®ÙˆÙ„',
            admin_button: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',
            primary_color: '#667eea',
            secondary_color: '#764ba2',
            text_color: '#333333',
            success_color: '#28a745',
            danger_color: '#dc3545',
            font_family: 'Segoe UI',
            font_size: 16
        };

        const dataHandler = {
            async onDataChanged(data) {
                allData = data;
               
                updateEntitySelect();
                if (document.getElementById('entitiesList')) renderEntitiesList();
                if (document.getElementById('adminQuizzesList')) renderAdminQuizzes();
                if (document.getElementById('quizzesList')) renderQuizzesList();
                if (document.getElementById('leaderboardBody')) renderLeaderboard();
                if (document.getElementById('membersList')) renderMembersList();
                if (document.getElementById('classesList')) renderClassesList(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„
                if (document.getElementById('studentsList')) renderStudentsList(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                if (document.getElementById('teacherStudentsList')) showTeacherClass(currentClassId); // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„Ù…
                if (document.getElementById('attendanceRecordsList') && document.getElementById('historyClassName').dataset.classId) {
                    renderAttendanceHistory(document.getElementById('historyClassName').dataset.classId);
                }
                
                // ğŸ†• ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                if (currentEntityId) {
                    updateEnrollmentCardVisibility(); 
                    updatePendingCount(); 
                }
            }
        };

        async function onConfigChange(config) {
            document.getElementById('mainTitle').textContent = config.main_title || defaultConfig.main_title;
            document.getElementById('welcomeMessage').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('enterButtonText').textContent = config.enter_button || defaultConfig.enter_button;
            document.getElementById('adminButtonText').textContent = config.admin_button || defaultConfig.admin_button;
            
            const customFont = config.font_family || defaultConfig.font_family;
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontFamily = `${customFont}, sans-serif`;
            document.body.style.fontSize = `${baseSize}px`;
        }
        
        const STATE_KEY = 'last_page_id'; // Ù…ÙØªØ§Ø­ Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage
        const ENTITY_KEY = 'current_entity_id'; // Ù…ÙØªØ§Ø­ Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø©

        async function initApp() {
            const dataInitResult = await window.dataSdk.init(dataHandler);
            if (!dataInitResult.isOk) {
                showToast('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Firebase.', true);
            }
            
            document.getElementById('entitySelect').addEventListener('change', function() {
                document.getElementById('enterEntityBtn').disabled = !this.value;
            });

            document.getElementById('enterEntityBtn').addEventListener('click', function() {
                const entityId = document.getElementById('entitySelect').value;
                if (entityId) {
                    currentEntityId = entityId;
                    showEntityPage();
                }
            });

            document.getElementById('superAdminBtn').addEventListener('click', function() {
                showPage('superAdminLoginPage');
            });

            const lastPageId = localStorage.getItem(STATE_KEY);
            const savedEntityId = localStorage.getItem(ENTITY_KEY);
            
            if (lastPageId && lastPageId !== 'homePage') {
                if (lastPageId === 'superAdminPage') {
                    showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', true);
                    showPage('superAdminLoginPage');
                    
                } else if (savedEntityId) {
                    currentEntityId = savedEntityId;
                    
                    if (lastPageId.includes('Admin') || lastPageId.includes('Management') || lastPageId.includes('myQuizzes')) {
                        showEntityPage();
                        showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù‡Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ± Ø£Ùˆ Ø¹Ø¶Ùˆ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
                    } else {
                        showPage(lastPageId);
                        showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± ØµÙØ­Ø© ÙƒÙ†Øª Ø¹Ù„ÙŠÙ‡Ø§.', false);
                    }
                } else {
                    showPage('homePage');
                }
            } else {
                showPage('homePage');
            }
            
            initWheel(); 
            initContestWheel(); // ØªÙ‡ÙŠØ¦Ø© Ø¹Ø¬Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        }

        function updateEntitySelect() {
            const select = document.getElementById('entitySelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø¬Ù‡Ø© --</option>';
            
            const entities = allData.filter(item => item.type === 'entity');
            entities.forEach(entity => {
                const option = document.createElement('option');
                option.value = entity.id;
                option.textContent = entity.entity_name;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function showPage(pageId) {
            const pages = ['homePage', 'superAdminLoginPage', 'superAdminPage', 'entityPage', 
                          'entityAdminLoginPage', 'entityAdminPage', 'quizzesPage', 
                          'takeQuizPage', 'leaderboardPage', 'wheelPage', 'membersManagementPage',
                          'addQuizPage', 'myQuizzesPage', 'participantsDetailsPage', 
                          'certificateManagementPage', 'classesManagementPage', 'classDetailsPage', 'teacherClassViewPage',
                          'attendanceHistoryPage', 'enrollmentSettingsPage', 'studentEnrollmentFormPage', 'pendingEnrollmentsPage'];
            
            pages.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            
            const excludedPages = ['homePage', 'superAdminLoginPage', 'entityAdminLoginPage', 'takeQuizPage', 'studentEnrollmentFormPage'];
            if (!excludedPages.includes(pageId)) {
                localStorage.setItem(STATE_KEY, pageId);
                if (currentEntityId) {
                    localStorage.setItem(ENTITY_KEY, currentEntityId);
                }
            } else if (pageId === 'homePage') {
                localStorage.removeItem(STATE_KEY);
                localStorage.removeItem(ENTITY_KEY);
            }
        }

        function goToHome() {
            currentEntityId = null; currentUserId = null; currentUserRole = null; isSuperAdmin = false;
            showPage('homePage');
        }

        function showEntityPage() {
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (entity) {
                document.getElementById('entityPageTitle').textContent = entity.entity_name;
                updateEnrollmentCardVisibility(); 
                showPage('entityPage');
            }
        }

        function goBackToEntity() { currentUserId = null; currentUserRole = null; showEntityPage(); }
        function goBackToEntityAdmin() { 
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø¹ÙˆØ¯Ø©
            if (currentUserRole) updateAdminDashboardUI(currentUserRole);
            updatePendingCount(); // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
            showPage('entityAdminPage'); 
        }
        function showMembersManagement() { renderMembersList(); showPage('membersManagementPage'); }
        
        function showAddQuizForm() {
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizTimer').value = '0';
            document.getElementById('enableCertificate').checked = false;
            const saveBtn = document.getElementById('saveQuizBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©';
            saveBtn.onclick = saveQuiz; 
            questionCounter = 0; 
            showPage('addQuizPage');
        }
        
        function showMyQuizzes() { renderAdminQuizzes(); showPage('myQuizzesPage'); }
        function goBackToMyQuizzes() { showMyQuizzes(); }
        
        function showQuizParticipants(quizBackendId) {
            const quiz = allData.find(item => item.__backendId === quizBackendId);
            if (!quiz) return;
            document.getElementById('participantsQuizTitle').textContent = 'Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† - ' + quiz.quiz_title;
            const results = allData.filter(item => item.type === 'result' && item.quiz_title === quiz.quiz_title && item.entity_id === currentEntityId);
            const questions = JSON.parse(quiz.questions);
            const container = document.getElementById('participantsDetailsList');
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø¹Ø±Ø¶Ù‡Ø§</p>';
                showPage('participantsDetailsPage');
                return;
            }
            results.sort((a, b) => b.score - a.score || a.time_taken - b.time_taken);
            container.innerHTML = results.map((result, rank) => {
                const completedDate = new Date(result.completed_at);
                return `
                    <div class="entity-card" style="border-right: 5px solid ${rank === 0 ? '#ffd700' : rank === 1 ? '#c0c0c0' : rank === 2 ? '#cd7f32' : '#667eea'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h4 style="margin: 0;">ğŸ… Ø§Ù„Ù…Ø±ÙƒØ² ${rank + 1}: ${result.participant_name}</h4>
                                <p style="margin: 5px 0; color: #666;">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result.score.toFixed(2)} Ù…Ù† ${questions.length} | Ø§Ù„ÙˆÙ‚Øª: ${result.time_taken} Ø«Ø§Ù†ÙŠØ©</p>
                                <p style="margin: 5px 0; color: #999; font-size: 0.9em;">${completedDate.toLocaleDateString('ar-SA')} - ${completedDate.toLocaleTimeString('ar-SA')}</p>
                            </div>
                        </div>
                        <button class="btn" style="padding: 8px 20px; margin-top: 10px;" onclick="showParticipantAnswers('${result.__backendId}', '${quiz.__backendId}')">ğŸ“„ Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
                    </div>
                `;
            }).join('');
            showPage('participantsDetailsPage');
        }
        
        function showParticipantAnswers(resultBackendId, quizBackendId) {
            const result = allData.find(item => item.__backendId === resultBackendId);
            const quiz = allData.find(item => item.__backendId === quizBackendId);
            if (!result || !quiz) return;
            
            const questions = JSON.parse(quiz.questions);
            const participantAnswers = result.user_answers ? JSON.parse(result.user_answers) : null;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 900px; margin: 0 auto; border-radius: 15px; padding: 30px; position: relative;';
            
            const completedDate = new Date(result.completed_at);
            const dateStr = completedDate.toLocaleDateString('ar-SA');
            const timeStr = completedDate.toLocaleTimeString('ar-SA');
            
            modalContent.innerHTML = `
                <button onclick="this.closest('[style*=fixed]').remove()" style="position: absolute; top: 15px; left: 15px; background: #dc3545; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2em; cursor: pointer; font-weight: bold;">Ã—</button>
                
                <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; margin-bottom: 25px;">
                    <h2 style="margin: 0 0 10px 0;">Ù…Ù„Ø®Øµ Ø¥Ø¬Ø§Ø¨Ø§Øª: ${result.participant_name}</h2>
                    <p style="margin: 0; font-size: 1.3em; font-weight: bold;">
                        Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${result.score.toFixed(2)} Ù…Ù† ${questions.length} (${Math.round((result.score / questions.length) * 100)}%)
                    </p>
                    <p style="margin: 5px 0;"><strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªØºØ±Ù‚:</strong> ${result.time_taken} Ø«Ø§Ù†ÙŠØ©</p>
                    <p style="margin: 5px 0; font-size: 0.9em; opacity: 0.9;">${dateStr} - ${timeStr}</p>
                </div>
                
                <h3 style="margin-bottom: 20px; color: #333;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:</h3>
                <div style="max-height: 60vh; overflow-y: auto;">
                    ${participantAnswers ? generateDetailedAnswersSummary(participantAnswers, questions) : generateParticipantAnswersSummary(result, questions)}
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }
        
        function generateParticipantAnswersSummary(result, questions) {
            let html = '';
            let currentScore = 0;
            
            questions.forEach((q, index) => {
                let isCorrect = false;
                let partialScore = 0;
                let answerText = '<span style="color: #999; font-style: italic;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø³Ø¬Ù„Ø©</span>';
                let correctAnswerText = '';
                
                if (q.type === 'multiple') {
                    correctAnswerText = q.answers[q.correct];
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                } else if (q.type === 'truefalse') {
                    correctAnswerText = q.correct ? 'ØµØ­' : 'Ø®Ø·Ø£';
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                } else if (q.type === 'text') {
                    correctAnswerText = q.correct;
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                } else if (q.type === 'checkbox') {
                    correctAnswerText = q.correct.map(i => q.answers[i]).join(' ØŒ ');
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                } else if (q.type === 'matching') {
                    correctAnswerText = q.pairs.map(p => `${p.left} âŸ· ${p.right}`).join(' | ');
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                } else if (q.type === 'ordering') {
                    correctAnswerText = q.correctOrder.join(' â† ');
                    answerText = '<span style="color: #999; font-style: italic;">ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©</span>';
                }
                
                const expectedScoreForQuestion = (result.score / questions.length);
                
                if (expectedScoreForQuestion >= 0.9) {
                    isCorrect = true;
                    partialScore = 1;
                } else if (expectedScoreForQuestion > 0) {
                    partialScore = expectedScoreForQuestion;
                }
                
                currentScore += partialScore;
                
                const bgColor = isCorrect ? '#d4edda' : (partialScore > 0 ? '#fff3cd' : '#f8d7da');
                const borderColor = isCorrect ? '#28a745' : (partialScore > 0 ? '#ffc107' : '#dc3545');
                const icon = isCorrect ? 'âœ“' : (partialScore > 0 ? 'â—' : 'âœ—');
                
                html += `
                    <div style="padding: 20px; background: ${bgColor}; border-radius: 10px; margin-bottom: 15px; border-right: 5px solid ${borderColor};">
                        <h4 style="margin: 0 0 10px 0;">${icon} Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${q.question}</h4>
                        <p style="margin: 5px 0;"><strong>Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ:</strong> ${answerText}</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</strong> ${correctAnswerText}</p>
                        ${partialScore > 0 && partialScore < 1 ? `<p style="margin: 5px 0; color: #856404;"><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${partialScore.toFixed(2)}/1</p>` : ''}
                    </div>
                `;
            });
            
            return html;
        }
        
        function generateDetailedAnswersSummary(participantAnswers, questions) {
            let html = '';
            
            participantAnswers.forEach((answer, index) => {
                const q = questions[index];
                let isCorrect = answer.isCorrect || false;
                let partialScore = answer.partialScore || 0;
                let userAnswerText = '';
                let correctAnswerText = '';
                
                if (q.type === 'multiple') {
                    userAnswerText = answer.userAnswer !== null && answer.userAnswer !== undefined ? q.answers[answer.userAnswer] : '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    correctAnswerText = q.answers[q.correct];
                } else if (q.type === 'truefalse') {
                    userAnswerText = answer.userAnswer !== null && answer.userAnswer !== undefined ? (answer.userAnswer ? 'ØµØ­' : 'Ø®Ø·Ø£') : '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    correctAnswerText = q.correct ? 'ØµØ­' : 'Ø®Ø·Ø£';
                } else if (q.type === 'text') {
                    userAnswerText = answer.userAnswer || '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    correctAnswerText = q.correct;
                } else if (q.type === 'checkbox') {
                    userAnswerText = answer.userAnswer && answer.userAnswer.length > 0 ? answer.userAnswer.map(i => q.answers[i]).join(' ØŒ ') : '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    correctAnswerText = q.correct.map(i => q.answers[i]).join(' ØŒ ');
                } else if (q.type === 'matching') {
                    if (answer.userAnswer && answer.userAnswer.length > 0) {
                        userAnswerText = q.pairs.map((p, i) => `${p.left} âŸ· ${answer.userAnswer[i] || 'ØŸ'}`).join(' | ');
                    } else {
                        userAnswerText = '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    }
                    correctAnswerText = q.pairs.map(p => `${p.left} âŸ· ${p.right}`).join(' | ');
                } else if (q.type === 'ordering') {
                    userAnswerText = answer.userAnswer && answer.userAnswer.length > 0 ? answer.userAnswer.join(' â† ') : '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨</span>';
                    correctAnswerText = q.correctOrder.join(' â† ');
                }
                
                const bgColor = isCorrect ? '#d4edda' : (partialScore > 0 ? '#fff3cd' : '#f8d7da');
                const borderColor = isCorrect ? '#28a745' : (partialScore > 0 ? '#ffc107' : '#dc3545');
                const icon = isCorrect ? 'âœ“' : (partialScore > 0 ? 'â—' : 'âœ—');
                
                html += `
                    <div style="padding: 20px; background: ${bgColor}; border-radius: 10px; margin-bottom: 15px; border-right: 5px solid ${borderColor};">
                        <h4 style="margin: 0 0 10px 0;">${icon} Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${q.question}</h4>
                        <p style="margin: 5px 0;"><strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${userAnswerText}</p>
                        <p style="margin: 5px 0; color: #155724;"><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${correctAnswerText}</p>
                        ${partialScore > 0 && partialScore < 1 ? `<p style="margin: 5px 0; color: #856404;"><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${partialScore.toFixed(2)}/1</p>` : ''}
                    </div>
                `;
            });
            
            return html;
        }

        async function loginSuperAdmin(event) {
            event.preventDefault();
            const username = document.getElementById('superAdminUsername').value;
            const password = document.getElementById('superAdminPassword').value;
            
            if (username === MASTER_USERNAME && password === MASTER_PASSWORD) {
                isSuperAdmin = true;
                showPage('superAdminPage');
                renderEntitiesList();
            } else {
                showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', true);
            }
        }

        async function addNewEntity() {
            if (allData.length >= 999) {
                showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Øª (999)', true);
                return;
            }

            const name = document.getElementById('newEntityName').value;
            const username = document.getElementById('newEntityAdminUsername').value;
            const password = document.getElementById('newEntityAdminPassword').value;
            
            if (!name || !username || !password) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
                return;
            }
            
            const entityId = 'entity_' + Date.now();
            const result = await window.dataSdk.create({
                id: entityId,
                type: 'entity',
                entity_id: entityId,
                entity_name: name,
                admin_username: username,
                admin_password: password,
                members: JSON.stringify([]),
                enrollment_config: JSON.stringify({ status: 'disabled', req_name: true }) // ğŸ†• Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            });
            
            if (result.isOk) {
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù‡Ø© Ø¨Ù†Ø¬Ø§Ø­');
                document.getElementById('newEntityName').value = '';
                document.getElementById('newEntityAdminUsername').value = '';
                document.getElementById('newEntityAdminPassword').value = '';
            } else {
                showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ù‡Ø©', true);
            }
        }
        
        function exportBackup() {
            const dataToExport = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_competition_data_${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­ (Array)');
                    }

                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                        return;
                    }

                    for (const item of importedData) {
                        // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Firestore Ø¬Ø¯ÙŠØ¯
                        const dataToImport = { ...item };
                        delete dataToImport.__backendId; // Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…
                        const result = await window.dataSdk.create(dataToImport);
                        if (!result.isOk) {
                            console.error('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³Ø¬Ù„:', item, result.error);
                            showToast('ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', true);
                        }
                    }
                    showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
                    // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ onSnapshot Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ø£Ù…Ø±
                } catch (error) {
                    console.error('ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
                    showToast(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${error.message}`, true);
                }
            };
            reader.readAsText(file);
        }

        function renderEntitiesList() {
            const container = document.getElementById('entitiesList');
            if (!container) return;
            
            const entities = allData.filter(item => item.type === 'entity');
            
            if (entities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
                return;
            }
            
            container.innerHTML = entities.map(entity => {
                const members = JSON.parse(entity.members || '[]');
                const quizzes = allData.filter(item => item.type === 'quiz' && item.entity_id === entity.id);
                
                return `
                    <div class="entity-card">
                        <h4>${entity.entity_name}</h4>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Ø§Ù„Ù…Ø¯ÙŠØ±:</strong> ${entity.admin_username}<br>
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</strong> ${members.length}<br>
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª:</strong> ${quizzes.length}
                        </p>
                        <div class="entity-card-actions">
                            <button class="btn" style="padding: 8px 20px;" onclick="editEntityCredentials('${entity.__backendId}')">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</button>
                            <button class="btn btn-danger" style="padding: 8px 20px;" onclick="deleteEntity('${entity.__backendId}')">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editEntityCredentials(backendId) {
            const entity = allData.find(item => item.__backendId === backendId);
            if (!entity) return;
            
            const newUsername = document.createElement('div');
            newUsername.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 1000; min-width: 400px;';
            newUsername.innerHTML = `
                <h3 style="margin-top: 0;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± - ${entity.entity_name}</h3>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                    <input type="text" id="editUsername" value="${entity.admin_username}">
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                    <input type="password" id="editPassword" value="${entity.admin_password}">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" style="flex: 1;" onclick="saveEntityCredentials('${backendId}')">Ø­ÙØ¸</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="this.parentElement.parentElement.remove()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            `;
            document.body.appendChild(newUsername);
        }
        
        async function saveEntityCredentials(backendId) {
            const entity = allData.find(item => item.__backendId === backendId);
            if (!entity) return;
            
            const newUsername = document.getElementById('editUsername').value;
            const newPassword = document.getElementById('editPassword').value;
            
            if (!newUsername || !newPassword) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
                return;
            }
            
            const updatedEntity = {
                ...entity,
                admin_username: newUsername,
                admin_password: newPassword
            };
            
            const result = await window.dataSdk.update(updatedEntity);
            
            if (result.isOk) {
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                document.querySelector('[style*="position: fixed"]').remove();
            } else {
                showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
            }
        }

        async function deleteEntity(backendId) {
            const record = allData.find(item => item.__backendId === backendId);
            if (record) {
                const result = await window.dataSdk.delete(record);
                if (result.isOk) {
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø© Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø©', true);
                }
            }
        }

        function showEntityAdminLogin() {
            showPage('entityAdminLoginPage');
        }

        function updateAdminDashboardUI(role) {
            const container = document.querySelector('#entityAdminPage .entity-sections');
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
            let baseHtml = '';
            
            if (role === 'manager') {
                baseHtml += `
                    <div id="managerSection">
                        <div class="section-card" onclick="showMembersManagement()">
                            <h3>ğŸ§‘â€ğŸ¤â€ğŸ§‘</h3>
                            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                        </div>
                    </div>
                    <div class="section-card" onclick="showClassesManagement()">
                        <h3>ğŸ«</h3>
                        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h3>
                    </div>
                    <div class="section-card" onclick="showCertificateManagement()">
                        <h3>ğŸ“</h3>
                        <h3>ØªØµÙ…ÙŠÙ… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</h3>
                    </div>
                    <div class="section-card" onclick="showEnrollmentSettings()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <h3>âœï¸</h3>
                        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                    </div>
                `;
            } else if (role === 'member') {
                // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ù„Ù„Ø¹Ø¶Ùˆ
                const myClasses = allData.filter(item => item.type === 'class' && item.entity_id === currentEntityId && item.assigned_member_id === currentUserId);

                if (myClasses.length > 0) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ÙØµÙ„ØŒ Ù†Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ù„ÙƒÙ„ ÙØµÙ„
                    myClasses.forEach(cls => {
                        baseHtml += `
                        <div class="section-card" onclick="showTeacherClass('${cls.id}')" data-class-id="${cls.id}">
                            <h3>ğŸ«</h3>
                            <h3>ÙØµÙ„ÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${cls.name}</h3>
                        </div>`;
                    });
                } else {
                    baseHtml += `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; color: #666;">
                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                    </div>`;
                }
            }

            // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©
            baseHtml += `
                <div class="section-card" onclick="showAddQuizForm()">
                    <h3>â•</h3>
                    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
                </div>
                <div class="section-card" onclick="showMyQuizzes()">
                    <h3>ğŸ“‹</h3>
                    <h3>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
                </div>
            `;
            
            container.innerHTML = baseHtml;
        }


        async function loginEntityAdmin(event) {
            event.preventDefault();
            const username = document.getElementById('entityAdminUsername').value;
            const password = document.getElementById('entityAdminPassword').value;
            
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (!entity) return;
            
            // ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¯ÙŠØ±
            if ((username === MASTER_USERNAME && password === MASTER_PASSWORD) ||
                (username === entity.admin_username && password === entity.admin_password)) {
                currentUserId = 'admin';
                currentUserRole = 'manager';
                document.getElementById('loggedInUserName').textContent = username;
                document.getElementById('userRole').textContent = 'Ù…Ø¯ÙŠØ±';
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø¯ÙŠØ± (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
                updateAdminDashboardUI('manager');
                
                showPage('entityAdminPage');
                return;
            }
            
            // ØªØ­Ù‚Ù‚ Ø§Ù„Ø¹Ø¶Ùˆ
            const members = JSON.parse(entity.members || '[]');
            const member = members.find(m => m.username === username && m.password === password);
            
            if (member) {
                currentUserId = member.id;
                currentUserRole = 'member';
                document.getElementById('loggedInUserName').textContent = username;
                document.getElementById('userRole').textContent = 'Ø¹Ø¶Ùˆ';
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø¹Ø¶Ùˆ
                updateAdminDashboardUI('member');
                
                showPage('entityAdminPage');
            } else {
                showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', true);
            }
        }

        async function addMember() {
            const username = document.getElementById('newMemberUsername').value;
            const password = document.getElementById('newMemberPassword').value;
            
            if (!username || !password) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
                return;
            }
            
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (!entity) return;
            
            const members = JSON.parse(entity.members || '[]');
            const memberId = 'member_' + Date.now();
            members.push({ id: memberId, username, password });
            
            const updatedEntity = { ...entity, members: JSON.stringify(members) };
            const result = await window.dataSdk.update(updatedEntity);
            
            if (result.isOk) {
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­');
                document.getElementById('newMemberUsername').value = '';
                document.getElementById('newMemberPassword').value = '';
            } else {
                showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ', true);
            }
        }

        function renderMembersList() {
            const container = document.getElementById('membersList');
            if (!container) return;
            
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (!entity) return;
            
            const members = JSON.parse(entity.members || '[]');
            
            if (members.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡</p>';
                return;
            }
            
            container.innerHTML = '<h4 style="margin-top: 20px;">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:</h4>' + members.map(member => `
                <div class="member-item">
                    <div>
                        <strong>${member.username}</strong>
                    </div>
                    <button class="btn btn-danger" style="width: auto; padding: 8px 20px;" onclick="deleteMember('${member.id}')">Ø­Ø°Ù</button>
                </div>
            `).join('');
        }

        async function deleteMember(memberId) {
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (!entity) return;
            
            const members = JSON.parse(entity.members || '[]');
            const updatedMembers = members.filter(m => m.id !== memberId);
            
            const updatedEntity = { ...entity, members: JSON.stringify(updatedMembers) };
            const result = await window.dataSdk.update(updatedEntity);
            
            if (result.isOk) {
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ', true);
            }
        }

        let questionCounter = 0;
        
        function addQuestionForm() {
            questionCounter++;
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-form';
            questionDiv.id = `question_${questionCounter}`;
            
            questionDiv.innerHTML = `
                <div class="question-form-header">
                    <h4>Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionCounter}</h4>
                    <div>
                        <button type="button" class="copy-question-btn" onclick="copyQuestion('question_${questionCounter}')">
                            ğŸ“„ Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„
                        </button>
                        <button class="remove-question-btn" onclick="removeQuestion('question_${questionCounter}')">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                    </div>
                </div>
                
                <div class="form-group question-type-selector">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <select id="qtype_${questionCounter}" onchange="updateQuestionType('question_${questionCounter}')">
                        <option value="multiple">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                        <option value="truefalse">ØµØ­ Ø£Ùˆ Ø®Ø·Ø£</option>
                        <option value="text">Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ©</option>
                        <option value="checkbox">Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ (Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø©)</option>
                        <option value="matching">Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</option>
                        <option value="ordering">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <input type="text" id="qtext_${questionCounter}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§" required>
                </div>
                
                <div id="answers_${questionCounter}">
                    </div>
            `;
            
            container.appendChild(questionDiv);
            updateQuestionType(`question_${questionCounter}`);
        }
        
        function copyQuestion(sourceQuestionId) {
            const sourceDiv = document.getElementById(sourceQuestionId);
            if (!sourceDiv) return;

            const qNum = sourceQuestionId.replace('question_', '');
            const qText = document.getElementById(`qtext_${qNum}`).value;
            const qType = document.getElementById(`qtype_${qNum}`).value;
            const questionData = { question: qText, type: qType };

            if (qType === 'multiple') {
                const answersList = document.getElementById(`answers_list_${qNum}`);
                const answers = [];
                for (let j = 0; j < answersList.children.length; j++) {
                    answers.push(document.getElementById(`ans_${qNum}_${j}`).value);
                }
                const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                questionData.answers = answers;
                questionData.correct = correctRadio ? parseInt(correctRadio.value) : 0;

            } else if (qType === 'truefalse') {
                const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                questionData.correct = correctRadio ? correctRadio.value === 'true' : false;

            } else if (qType === 'text') {
                questionData.correct = document.getElementById(`correct_text_${qNum}`).value;

            } else if (qType === 'checkbox') {
                const answersList = document.getElementById(`answers_list_${qNum}`);
                const answers = [];
                const correct = [];
                for (let j = 0; j < answersList.children.length; j++) {
                    answers.push(document.getElementById(`ans_${qNum}_${j}`).value);
                    const checkbox = answersList.children[j].querySelector(`input[type="checkbox"]`);
                    if (checkbox && checkbox.checked) correct.push(j);
                }
                questionData.answers = answers;
                questionData.correct = correct;

            } else if (qType === 'matching') {
                const matchingList = document.getElementById(`matching_list_${qNum}`);
                const pairs = [];
                for (let j = 0; j < matchingList.children.length; j++) {
                    pairs.push({
                        left: document.getElementById(`match_left_${qNum}_${j}`).value,
                        right: document.getElementById(`match_right_${qNum}_${j}`).value
                    });
                }
                questionData.pairs = pairs;

            } else if (qType === 'ordering') {
                const orderingList = document.getElementById(`ordering_list_${qNum}`);
                const items = [];
                for (let j = 0; j < orderingList.children.length; j++) {
                    items.push(document.getElementById(`order_${qNum}_${j}`).value);
                }
                questionData.correctOrder = items;
            }

            questionCounter++;
            const container = document.getElementById('questionsContainer');
            const newQuestionId = `question_${questionCounter}`;
            const newDiv = document.createElement('div');
            newDiv.className = 'question-form';
            newDiv.id = newQuestionId;

            newDiv.innerHTML = `
                <div class="question-form-header">
                    <h4>Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionCounter} (Ù†Ø³Ø®Ø©)</h4>
                    <div>
                        <button type="button" class="copy-question-btn" onclick="copyQuestion('${newQuestionId}')">
                            ğŸ“„ Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„
                        </button>
                        <button class="remove-question-btn" onclick="removeQuestion('${newQuestionId}')">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                    </div>
                </div>
                
                <div class="form-group question-type-selector">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <select id="qtype_${questionCounter}" onchange="updateQuestionType('${newQuestionId}')">
                        <option value="multiple" ${qType === 'multiple' ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                        <option value="truefalse" ${qType === 'truefalse' ? 'selected' : ''}>ØµØ­ Ø£Ùˆ Ø®Ø·Ø£</option>
                        <option value="text" ${qType === 'text' ? 'selected' : ''}>Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ©</option>
                        <option value="checkbox" ${qType === 'checkbox' ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ (Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø©)</option>
                        <option value="matching" ${qType === 'matching' ? 'selected' : ''}>Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</option>
                        <option value="ordering" ${qType === 'ordering' ? 'selected' : ''}>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                    <input type="text" id="qtext_${questionCounter}" value="${questionData.question}" required>
                </div>
                
                <div id="answers_${questionCounter}"></div>
            `;
            
            sourceDiv.insertAdjacentElement('afterend', newDiv);
            updateQuestionTypeWithData(newQuestionId, questionData);
            showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
        }

        function updateQuestionType(questionId) {
            const qNum = questionId.replace('question_', '');
            const type = document.getElementById(`qtype_${qNum}`).value;
            const answersContainer = document.getElementById(`answers_${qNum}`);
            
            if (type === 'multiple') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©):</label>
                    <div id="answers_list_${qNum}">
                        <div class="answer-input-group">
                            <input type="radio" name="correct_${qNum}" value="0" checked>
                            <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© 1" id="ans_${qNum}_0" required>
                        </div>
                        <div class="answer-input-group">
                            <input type="radio" name="correct_${qNum}" value="1">
                            <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© 2" id="ans_${qNum}_1" required>
                        </div>
                    </div>
                    <button type="button" class="add-answer-btn" onclick="addAnswerOption('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø¨Ø©</button>
                `;
            } else if (type === 'truefalse') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
                    <div class="answer-input-group">
                        <input type="radio" name="correct_${qNum}" value="true" checked>
                        <label>ØµØ­</label>
                    </div>
                    <div class="answer-input-group">
                        <input type="radio" name="correct_${qNum}" value="false">
                        <label>Ø®Ø·Ø£</label>
                    </div>
                `;
            } else if (type === 'text') {
                answersContainer.innerHTML = `
                    <div class="form-group">
                        <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
                        <input type="text" id="correct_text_${qNum}" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©" required>
                    </div>
                `;
            } else if (type === 'checkbox') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©):</label>
                    <div id="answers_list_${qNum}">
                        <div class="answer-input-group">
                            <input type="checkbox" class="correct_checkbox_${qNum}" value="0" checked>
                            <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© 1" id="ans_${qNum}_0" required>
                        </div>
                        <div class="answer-input-group">
                            <input type="checkbox" class="correct_checkbox_${qNum}" value="1">
                            <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© 2" id="ans_${qNum}_1" required>
                        </div>
                    </div>
                    <button type="button" class="add-answer-btn" onclick="addAnswerOptionCheckbox('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø¨Ø©</button>
                `;
            } else if (type === 'matching') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</label>
                    <div id="matching_list_${qNum}">
                        <div class="answer-input-group">
                            <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± 1" id="match_left_${qNum}_0" required style="flex: 1;">
                            <span style="margin: 0 10px;">âŸ·</span>
                            <input type="text" placeholder="Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ 1" id="match_right_${qNum}_0" required style="flex: 1;">
                        </div>
                        <div class="answer-input-group">
                            <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± 2" id="match_left_${qNum}_1" required style="flex: 1;">
                            <span style="margin: 0 10px;">âŸ·</span>
                            <input type="text" placeholder="Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ 2" id="match_right_${qNum}_1" required style="flex: 1;">
                        </div>
                    </div>
                    <button type="button" class="add-answer-btn" onclick="addMatchingPair('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬</button>
                `;
            } else if (type === 'ordering') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:</label>
                    <div id="ordering_list_${qNum}">
                        <div class="answer-input-group">
                            <span style="font-weight: bold;">1.</span>
                            <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙˆÙ„" id="order_${qNum}_0" required>
                        </div>
                        <div class="answer-input-group">
                            <span style="font-weight: bold;">2.</span>
                            <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø«Ø§Ù†ÙŠ" id="order_${qNum}_1" required>
                        </div>
                    </div>
                    <button type="button" class="add-answer-btn" onclick="addOrderingItem('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>
                `;
            }
        }
        
        function addAnswerOption(qNum) {
            const list = document.getElementById(`answers_list_${qNum}`);
            const count = list.children.length;
            const div = document.createElement('div');
            div.className = 'answer-input-group';
            div.innerHTML = `
                <input type="radio" name="correct_${qNum}" value="${count}">
                <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${count + 1}" id="ans_${qNum}_${count}" required>
                <button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(div);
        }
        
        function addAnswerOptionCheckbox(qNum) {
            const list = document.getElementById(`answers_list_${qNum}`);
            const count = list.children.length;
            const div = document.createElement('div');
            div.className = 'answer-input-group';
            div.innerHTML = `
                <input type="checkbox" class="correct_checkbox_${qNum}" value="${count}">
                <input type="text" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${count + 1}" id="ans_${qNum}_${count}" required>
                <button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(div);
        }
        
        function addMatchingPair(qNum) {
            const list = document.getElementById(`matching_list_${qNum}`);
            const count = list.children.length;
            const div = document.createElement('div');
            div.className = 'answer-input-group';
            div.innerHTML = `
                <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± ${count + 1}" id="match_left_${qNum}_${count}" required style="flex: 1;">
                <span style="margin: 0 10px;">âŸ·</span>
                <input type="text" placeholder="Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ${count + 1}" id="match_right_${qNum}_${count}" required style="flex: 1;">
                <button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(div);
        }
        
        function addOrderingItem(qNum) {
            const list = document.getElementById(`ordering_list_${qNum}`);
            const count = list.children.length;
            const div = document.createElement('div');
            div.className = 'answer-input-group';
            div.innerHTML = `
                <span style="font-weight: bold;">${count + 1}.</span>
                <input type="text" placeholder="Ø§Ù„Ø¹Ù†ØµØ± ${count + 1}" id="order_${qNum}_${count}" required>
                <button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(div);
        }
        
        function removeQuestion(questionId) {
            document.getElementById(questionId).remove();
        }
        
        async function saveQuiz() {
            const saveBtn = document.getElementById('saveQuizBtn');
            const originalText = saveBtn.textContent;
            
            if (allData.length >= 999) {
                showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª (999)', true);
                return;
            }

            const title = document.getElementById('quizTitle').value;
            const type = document.getElementById('quizType').value;
            const visibility = document.getElementById('quizVisibility').value;
            const timeLimit = parseInt(document.getElementById('quizTimer').value) || 0;
            const enableCert = document.getElementById('enableCertificate').checked;
            
            if (!title) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true);
                return;
            }
            
            const questionsContainer = document.getElementById('questionsContainer');
            if (questionsContainer.children.length === 0) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', true);
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            const questions = [];
            
            try {
                for (let i = 0; i < questionsContainer.children.length; i++) {
                    const qDiv = questionsContainer.children[i];
                    const qNum = qDiv.id.replace('question_', '');
                    const qText = document.getElementById(`qtext_${qNum}`).value;
                    const qType = document.getElementById(`qtype_${qNum}`).value;
                    
                    if (!qText) {
                        showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true);
                        saveBtn.disabled = false; saveBtn.textContent = originalText; return;
                    }
                    
                    const questionData = { question: qText, type: qType };
                    
                    if (qType === 'multiple') {
                        const answersList = document.getElementById(`answers_list_${qNum}`);
                        const answers = [];
                        for (let j = 0; j < answersList.children.length; j++) {
                            const ansText = document.getElementById(`ans_${qNum}_${j}`).value;
                            if (!ansText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            answers.push(ansText);
                        }
                        const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                        questionData.answers = answers;
                        questionData.correct = parseInt(correctRadio.value);
                    } else if (qType === 'truefalse') {
                        const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                        questionData.correct = correctRadio.value === 'true';
                    } else if (qType === 'text') {
                        const correctText = document.getElementById(`correct_text_${qNum}`).value;
                        if (!correctText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                        questionData.correct = correctText;
                    } else if (qType === 'checkbox') {
                        const answersList = document.getElementById(`answers_list_${qNum}`);
                        const answers = [];
                        const correct = [];
                        for (let j = 0; j < answersList.children.length; j++) {
                            const ansText = document.getElementById(`ans_${qNum}_${j}`).value;
                            if (!ansText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            answers.push(ansText);
                            const checkbox = answersList.children[j].querySelector(`input[type="checkbox"]`);
                            if (checkbox.checked) correct.push(j);
                        }
                        if (correct.length === 0) { showToast(`ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                        questionData.answers = answers;
                        questionData.correct = correct;
                    } else if (qType === 'matching') {
                        const matchingList = document.getElementById(`matching_list_${qNum}`);
                        const pairs = [];
                        for (let j = 0; j < matchingList.children.length; j++) {
                            const left = document.getElementById(`match_left_${qNum}_${j}`).value;
                            const right = document.getElementById(`match_right_${qNum}_${j}`).value;
                            if (!left || !right) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø²ÙˆØ¬ ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            pairs.push({ left, right });
                        }
                        questionData.pairs = pairs;
                    } else if (qType === 'ordering') {
                        const orderingList = document.getElementById(`ordering_list_${qNum}`);
                        const items = [];
                        for (let j = 0; j < orderingList.children.length; j++) {
                            const item = document.getElementById(`order_${qNum}_${j}`).value;
                            if (!item) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ØµØ± ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            items.push(item);
                        }
                        questionData.correctOrder = items;
                    }
                    
                    questions.push(questionData);
                }
            
                const quizId = 'quiz_' + Date.now();
                const result = await window.dataSdk.create({
                    id: quizId,
                    type: 'quiz',
                    entity_id: currentEntityId,
                    quiz_title: title,
                    quiz_type: type,
                    visibility: visibility,
                    creator_id: currentUserId,
                    questions: JSON.stringify(questions),
                    time_limit: timeLimit, 
                    enable_cert: enableCert
                });
                
                if (result.isOk) {
                    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    showMyQuizzes();
                } else {
                    throw new Error("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
                }
            } catch (error) {
                console.error("Save Quiz Failed:", error);
                showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        function renderAdminQuizzes() {
            const container = document.getElementById('adminQuizzesList');
            if (!container) return;
            
            let quizzes = allData.filter(item => item.type === 'quiz' && item.entity_id === currentEntityId);
            
            if (currentUserRole === 'member') {
                quizzes = quizzes.filter(q => q.creator_id === currentUserId);
            }
            
            if (quizzes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</p>';
                return;
            }
            
            container.innerHTML = quizzes.map(quiz => {
                const results = allData.filter(item => item.type === 'result' && item.quiz_title === quiz.quiz_title && item.entity_id === currentEntityId);
                const questions = JSON.parse(quiz.questions);
                const totalQuestions = questions.length;
                const participantsCount = results.length;
                const averageScore = participantsCount > 0 ? (results.reduce((sum, r) => sum + r.score, 0) / participantsCount).toFixed(2) : 0;
                const highestScore = participantsCount > 0 ? Math.max(...results.map(r => r.score)).toFixed(2) : 0;
                const lowestScore = participantsCount > 0 ? Math.min(...results.map(r => r.score)).toFixed(2) : 0;
                
                return `
                    <div class="quiz-item">
                        <h4>${quiz.quiz_title}</h4>
                        <div class="quiz-item-meta">
                            <span>Ø§Ù„Ù†ÙˆØ¹: ${quiz.quiz_type === 'quiz' ? 'Ø§Ø®ØªØ¨Ø§Ø±' : 'Ù…Ø³Ø§Ø¨Ù‚Ø©'}</span>
                            <span>Ø§Ù„Ø±Ø¤ÙŠØ©: ${quiz.visibility === 'public' ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}</span>
                            <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${totalQuestions}</span>
                        </div>
                        
                        ${participantsCount > 0 ? `
                            <div class="stats-summary">
                                <h5>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</h5>
                                <div class="stats-grid">
                                    <div><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†:</strong> ${participantsCount}</div>
                                    <div><strong>Ø§Ù„Ù…ØªÙˆØ³Ø·:</strong> ${averageScore}/${totalQuestions}</div>
                                    <div><strong>Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©:</strong> ${highestScore}/${totalQuestions}</div>
                                    <div><strong>Ø£Ù‚Ù„ Ù†ØªÙŠØ¬Ø©:</strong> ${lowestScore}/${totalQuestions}</div>
                                </div>
                                <button class="btn" style="margin-top: 10px; padding: 8px 20px;" onclick="showQuizParticipants('${quiz.__backendId}')">ğŸ“‹ Ø¹Ø±Ø¶ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</button>
                            </div>
                        ` : '<p style="margin: 10px 0; color: #999; font-style: italic;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</p>'}
                        
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn" style="width: auto; padding: 8px 20px; flex: 1;" onclick="editQuiz('${quiz.__backendId}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn" style="width: auto; padding: 8px 20px; flex: 1; background: #17a2b8;" onclick="printQuiz('${quiz.__backendId}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                            <button class="btn btn-secondary" style="width: auto; padding: 8px 20px; flex: 1;" onclick="copyQuiz('${quiz.__backendId}')">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
                            <button class="btn btn-danger" style="width: auto; padding: 8px 20px; flex: 1;" onclick="deleteQuiz('${quiz.__backendId}')">Ø­Ø°Ù</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function copyQuiz(backendId) {
            if (allData.length >= 999) { showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª (999)', true); return; }
            const quiz = allData.find(item => item.__backendId === backendId);
            if (!quiz) { showToast('Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', true); return; }
            const dateStr = new Date().toLocaleDateString('ar-SA');
            const newTitle = `Ù†Ø³Ø®Ø© Ù…Ù† ${quiz.quiz_title} (${dateStr})`;
            const newQuiz = {
                ...quiz, __backendId: undefined, id: 'quiz_' + Date.now(),
                quiz_title: newTitle, questions: quiz.questions,
                time_limit: quiz.time_limit || 0, enable_cert: quiz.enable_cert || false
            };
            const result = await window.dataSdk.create(newQuiz);
            if (result.isOk) { showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­: ' + newTitle); } else { showToast('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true); }
        }


        function editQuiz(backendId) {
            const quiz = allData.find(item => item.__backendId === backendId);
            if (!quiz) return;
            document.getElementById('quizTitle').value = quiz.quiz_title;
            document.getElementById('quizType').value = quiz.quiz_type;
            document.getElementById('quizVisibility').value = quiz.visibility;
            document.getElementById('quizTimer').value = quiz.time_limit || 0;
            document.getElementById('enableCertificate').checked = quiz.enable_cert || false;
            
            const questions = JSON.parse(quiz.questions);
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = '';
            questionCounter = 0;
            
            questions.forEach((q, index) => {
                questionCounter++;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-form';
                questionDiv.id = `question_${questionCounter}`;
                
                questionDiv.innerHTML = `
                    <div class="question-form-header">
                        <h4>Ø§Ù„Ø³Ø¤Ø§Ù„ ${questionCounter}</h4>
                        <div>
                            <button type="button" class="copy-question-btn" onclick="copyQuestion('question_${questionCounter}')">
                                ğŸ“„ Ù†Ø³Ø® Ø§Ù„Ø³Ø¤Ø§Ù„
                            </button>
                            <button class="remove-question-btn" onclick="removeQuestion('question_${questionCounter}')">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                        </div>
                    </div>
                    
                    <div class="form-group question-type-selector">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                        <select id="qtype_${questionCounter}" onchange="updateQuestionType('question_${questionCounter}')">
                            <option value="multiple" ${q.type === 'multiple' ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</option>
                            <option value="truefalse" ${q.type === 'truefalse' ? 'selected' : ''}>ØµØ­ Ø£Ùˆ Ø®Ø·Ø£</option>
                            <option value="text" ${q.type === 'text' ? 'selected' : ''}>Ø¥Ø¬Ø§Ø¨Ø© Ù†ØµÙŠØ©</option>
                            <option value="checkbox" ${q.type === 'checkbox' ? 'selected' : ''}>Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ (Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø©)</option>
                            <option value="matching" ${q.type === 'matching' ? 'selected' : ''}>Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</option>
                            <option value="ordering" ${q.type === 'ordering' ? 'selected' : ''}>Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
                        <input type="text" id="qtext_${questionCounter}" value="${q.question}" required>
                    </div>
                    
                    <div id="answers_${questionCounter}"></div>
                `;
                
                questionsContainer.appendChild(questionDiv);
                updateQuestionTypeWithData(`question_${questionCounter}`, q);
            });
            
            document.getElementById('saveQuizBtn').disabled = false;
            document.getElementById('saveQuizBtn').onclick = () => updateQuiz(backendId);
            document.getElementById('saveQuizBtn').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©';
            showPage('addQuizPage');
        }
        
        function updateQuestionTypeWithData(questionId, questionData) {
            const qNum = questionId.replace('question_', '');
            const type = document.getElementById(`qtype_${qNum}`).value;
            const answersContainer = document.getElementById(`answers_${qNum}`);
            
            if (type === 'multiple') {
                let answersHtml = `<label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©):</label><div id="answers_list_${qNum}">`;
                questionData.answers.forEach((ans, i) => {
                    answersHtml += `<div class="answer-input-group">
                            <input type="radio" name="correct_${qNum}" value="${i}" ${i === questionData.correct ? 'checked' : ''}>
                            <input type="text" value="${ans}" id="ans_${qNum}_${i}" required>
                            ${i > 1 ? '<button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>' : ''}
                        </div>`;
                });
                answersHtml += `</div><button type="button" class="add-answer-btn" onclick="addAnswerOption('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø¨Ø©</button>`;
                answersContainer.innerHTML = answersHtml;
            } else if (type === 'truefalse') {
                answersContainer.innerHTML = `
                    <label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label>
                    <div class="answer-input-group">
                        <input type="radio" name="correct_${qNum}" value="true" ${questionData.correct === true ? 'checked' : ''}>
                        <label>ØµØ­</label>
                    </div>
                    <div class="answer-input-group">
                        <input type="radio" name="correct_${qNum}" value="false" ${questionData.correct === false ? 'checked' : ''}>
                        <label>Ø®Ø·Ø£</label>
                    </div>
                `;
            } else if (type === 'text') {
                answersContainer.innerHTML = `<div class="form-group"><label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</label><input type="text" id="correct_text_${qNum}" value="${questionData.correct}" required></div>`;
            } else if (type === 'checkbox') {
                let answersHtml = `<label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©):</label><div id="answers_list_${qNum}">`;
                questionData.answers.forEach((ans, i) => {
                    answersHtml += `<div class="answer-input-group">
                            <input type="checkbox" class="correct_checkbox_${qNum}" value="${i}" ${questionData.correct.includes(i) ? 'checked' : ''}>
                            <input type="text" value="${ans}" id="ans_${qNum}_${i}" required>
                            ${i > 1 ? '<button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>' : ''}
                        </div>`;
                });
                answersHtml += `</div><button type="button" class="add-answer-btn" onclick="addAnswerOptionCheckbox('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø¨Ø©</button>`;
                answersContainer.innerHTML = answersHtml;
            } else if (type === 'matching') {
                let answersHtml = `<label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</label><div id="matching_list_${qNum}">`;
                questionData.pairs.forEach((pair, i) => {
                    answersHtml += `<div class="answer-input-group">
                            <input type="text" value="${pair.left}" id="match_left_${qNum}_${i}" required style="flex: 1;">
                            <span style="margin: 0 10px;">âŸ·</span>
                            <input type="text" value="${pair.right}" id="match_right_${qNum}_${i}" required style="flex: 1;">
                            ${i > 1 ? '<button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>' : ''}
                        </div>`;
                });
                answersHtml += `</div><button type="button" class="add-answer-btn" onclick="addMatchingPair('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬</button>`;
                answersContainer.innerHTML = answersHtml;
            } else if (type === 'ordering') {
                let answersHtml = `<label style="font-weight: bold; display: block; margin-bottom: 10px;">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:</label><div id="ordering_list_${qNum}">`;
                questionData.correctOrder.forEach((item, i) => {
                    answersHtml += `<div class="answer-input-group">
                            <span style="font-weight: bold;">${i + 1}.</span>
                            <input type="text" value="${item}" id="order_${qNum}_${i}" required>
                            ${i > 1 ? '<button type="button" class="remove-answer-btn" onclick="this.parentElement.remove()">Ã—</button>' : ''}
                        </div>`;
                });
                answersHtml += `</div><button type="button" class="add-answer-btn" onclick="addOrderingItem('${qNum}')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>`;
                answersContainer.innerHTML = answersHtml;
            }
        }
        
        async function updateQuiz(backendId) {
            const saveBtn = document.getElementById('saveQuizBtn');
            const originalText = saveBtn.textContent;
            
            const quiz = allData.find(item => item.__backendId === backendId);
            if (!quiz) return;
            
            const title = document.getElementById('quizTitle').value;
            const type = document.getElementById('quizType').value;
            const visibility = document.getElementById('quizVisibility').value;
            const timeLimit = parseInt(document.getElementById('quizTimer').value) || 0;
            const enableCert = document.getElementById('enableCertificate').checked;
            
            if (!title) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true); return; }
            const questionsContainer = document.getElementById('questionsContainer');
            if (questionsContainer.children.length === 0) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', true); return; }
            
            saveBtn.disabled = true; saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';

            const questions = [];
            
            try {
                for (let i = 0; i < questionsContainer.children.length; i++) {
                    const qDiv = questionsContainer.children[i];
                    const qNum = qDiv.id.replace('question_', '');
                    const qText = document.getElementById(`qtext_${qNum}`).value;
                    const qType = document.getElementById(`qtype_${qNum}`).value;
                    
                    if (!qText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                    
                    const questionData = { question: qText, type: qType };
                    
                    if (qType === 'multiple') {
                        const answersList = document.getElementById(`answers_list_${qNum}`);
                        const answers = [];
                        for (let j = 0; j < answersList.children.length; j++) {
                            const ansText = document.getElementById(`ans_${qNum}_${j}`).value;
                            if (!ansText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            answers.push(ansText);
                        }
                        const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                        questionData.answers = answers;
                        questionData.correct = parseInt(correctRadio.value);
                    } else if (qType === 'truefalse') {
                        const correctRadio = document.querySelector(`input[name="correct_${qNum}"]:checked`);
                        questionData.correct = correctRadio.value === 'true';
                    } else if (qType === 'text') {
                        const correctText = document.getElementById(`correct_text_${qNum}`).value;
                        if (!correctText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                        questionData.correct = correctText;
                    } else if (qType === 'checkbox') {
                        const answersList = document.getElementById(`answers_list_${qNum}`);
                        const answers = [];
                        const correct = [];
                        for (let j = 0; j < answersList.children.length; j++) {
                            const ansText = document.getElementById(`ans_${qNum}_${j}`).value;
                            if (!ansText) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            answers.push(ansText);
                            const checkbox = answersList.children[j].querySelector(`input[type="checkbox"]`);
                            if (checkbox.checked) correct.push(j);
                        }
                        if (correct.length === 0) { showToast(`ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                        questionData.answers = answers;
                        questionData.correct = correct;
                    } else if (qType === 'matching') {
                        const matchingList = document.getElementById(`matching_list_${qNum}`);
                        const pairs = [];
                        for (let j = 0; j < matchingList.children.length; j++) {
                            const left = document.getElementById(`match_left_${qNum}_${j}`).value;
                            const right = document.getElementById(`match_right_${qNum}_${j}`).value;
                            if (!left || !right) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø²ÙˆØ¬ ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            pairs.push({ left, right });
                        }
                        questionData.pairs = pairs;
                    } else if (qType === 'ordering') {
                        const orderingList = document.getElementById(`ordering_list_${qNum}`);
                        const items = [];
                        for (let j = 0; j < orderingList.children.length; j++) {
                            const item = document.getElementById(`order_${qNum}_${j}`).value;
                            if (!item) { showToast(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ØµØ± ${j + 1} ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true); saveBtn.disabled = false; saveBtn.textContent = originalText; return; }
                            items.push(item);
                        }
                        questionData.correctOrder = items;
                    }
                    
                    questions.push(questionData);
                }
                
                const updatedQuiz = {
                    ...quiz, quiz_title: title, quiz_type: type, visibility: visibility,
                    questions: JSON.stringify(questions), time_limit: timeLimit, enable_cert: enableCert
                };
                
                const result = await window.dataSdk.update(updatedQuiz);
                
                if (result.isOk) {
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    document.getElementById('saveQuizBtn').onclick = saveQuiz;
                    document.getElementById('saveQuizBtn').textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©';
                    saveBtn.disabled = false;
                    showMyQuizzes();
                } else {
                    throw new Error("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
                }
            } catch (error) {
                console.error("Update Quiz Failed:", error);
                showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        async function deleteQuiz(backendId) {
            const record = allData.find(item => item.__backendId === backendId);
            if (record) {
                const result = await window.dataSdk.delete(record);
                if (result.isOk) { showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­'); } else { showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©', true); }
            }
        }

        function printQuiz(backendId) {
            const quiz = allData.find(item => item.__backendId === backendId);
            if (!quiz) return;
            const questions = JSON.parse(quiz.questions);
            const entity = allData.find(e => e.type === 'entity' && e.id === quiz.entity_id);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ø·Ø¨Ø§Ø¹Ø© - ${quiz.quiz_title}</title>
                    <style> @media print { @page { size: A4; margin: 2cm; } .no-print { display: none; } }
                        body { font-family: 'Traditional Arabic', 'Arial', sans-serif; line-height: 1.8; color: #000; background: white; padding: 20px; max-width: 210mm; margin: 0 auto; }
                        .header { text-align: center; border-bottom: 3px double #000; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { font-size: 28px; margin: 10px 0; font-weight: bold; }
                        .info-section { display: flex; justify-content: space-between; margin: 20px 0 30px 0; padding: 15px; border: 2px solid #000; background: #f9f9f9; }
                        .question { margin: 25px 0; padding: 15px; border: 2px solid #333; border-radius: 8px; background: white; page-break-inside: avoid; }
                        .question-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
                        .question-text { margin-bottom: 10px; }
                        .answer-option { display: block; padding: 10px 15px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; background: #fafafa; font-size: 15px; }
                        .answer-option::before { content: "â—‹"; margin-left: 10px; font-size: 18px; }
                        .answer-space { margin-top: 15px; padding: 15px; border: 1px dashed #999; min-height: 60px; background: #f9f9f9; }
                        .answer-space::before { content: "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: "; font-weight: bold; color: #666; }
                        .matching-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        .matching-table td { padding: 12px; border: 1px solid #333; font-size: 15px; }
                        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #000; font-size: 14px; color: #666; }
                        .print-button { position: fixed; top: 20px; left: 20px; background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; }
                    </style>
                </head>
                <body>
                    <button class="print-button no-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <div class="header"><h1>${quiz.quiz_title}</h1><p>${entity ? entity.entity_name : ''}</p><p>${quiz.quiz_type === 'quiz' ? 'Ø§Ø®ØªØ¨Ø§Ø±' : 'Ù…Ø³Ø§Ø¨Ù‚Ø©'} - ${quiz.visibility === 'public' ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}</p></div>
                    <div class="info-section"><div class="info-item"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> _______________________________</div><div class="info-item"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> _______________________________</div></div>
                    <div class="info-section"><div class="info-item"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</strong> ${questions.length}</div><div class="info-item"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</strong> ${questions.length}</div><div class="info-item"><strong>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</strong> _______</div></div>
                    ${generatePrintableQuestions(questions)}
                    <div class="footer"><p>Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­</p><p>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</p></div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function generatePrintableQuestions(questions) {
            let html = '';
            questions.forEach((q, index) => {
                html += `<div class="question"><div class="question-header">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}</div><div class="question-text">${q.question}</div>`;
                if (q.type === 'multiple') {
                    html += `<div class="answers">`;
                    q.answers.forEach((answer, i) => { html += `<div class="answer-option">${answer}</div>`; });
                    html += `</div>`;
                } else if (q.type === 'truefalse') {
                    html += `<div class="answers"><div class="answer-option">ØµØ­</div><div class="answer-option">Ø®Ø·Ø£</div></div>`;
                } else if (q.type === 'text') {
                    html += `<div class="answer-space"></div>`;
                } else if (q.type === 'checkbox') {
                    html += `<div class="answers"><p style="margin: 10px 0; font-weight: bold; color: #666;">(Ø§Ø®ØªØ± Ø£ÙƒØ«Ø± Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø©)</p>`;
                    q.answers.forEach((answer, i) => { html += `<div class="answer-option">${answer}</div>`; });
                    html += `</div>`;
                } else if (q.type === 'matching') {
                    html += `<p style="margin: 10px 0; font-weight: bold; color: #666;">ØµÙ„ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ù‡ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±:</p><table class="matching-table">`;
                    const shuffledRight = [...q.pairs.map(p => p.right)].sort(() => Math.random() - 0.5);
                    q.pairs.forEach((pair, i) => { html += `<tr><td class="left-col">${pair.left}</td><td class="answer-col">( )</td><td class="right-col">${shuffledRight[i]}</td></tr>`; });
                    html += `</table>`;
                } else if (q.type === 'ordering') {
                    html += `<p style="margin: 10px 0; font-weight: bold; color: #666;">Ø±ØªØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:</p><div class="ordering-items">`;
                    const shuffled = [...q.correctOrder].sort(() => Math.random() - 0.5);
                    shuffled.forEach((item, i) => { html += `<div class="ordering-item">( ) ${item}</div>`; });
                    html += `</div>`;
                }
                html += `</div>`;
            });
            return html;
        }
        
        function showQuizzesSection() {
            document.getElementById('quizzesBackBtn').onclick = goBackToEntity;
            renderQuizzesList();
            showPage('quizzesPage');
        }

        function showPublicQuizzes() {
            document.getElementById('quizzesBackBtn').onclick = goToHome;
            currentEntityId = null;
            renderQuizzesList();
            showPage('quizzesPage');
        }

        function renderQuizzesList() {
            const container = document.getElementById('quizzesList');
            if (!container) return;
            
            let quizzes;
            if (currentEntityId) {
                quizzes = allData.filter(item => item.type === 'quiz' && item.entity_id === currentEntityId);
            } else {
                quizzes = allData.filter(item => item.type === 'quiz' && item.visibility === 'public');
            }
            
            if (quizzes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ù…ØªØ§Ø­Ø©</p>';
                return;
            }
            
            container.innerHTML = quizzes.map(quiz => {
                const entity = allData.find(e => e.type === 'entity' && e.id === quiz.entity_id);
                return `
                    <div class="quiz-item">
                        <h4>${quiz.quiz_title}</h4>
                        <div class="quiz-item-meta">
                            <span>Ø§Ù„Ù†ÙˆØ¹: ${quiz.quiz_type === 'quiz' ? 'Ø§Ø®ØªØ¨Ø§Ø±' : 'Ù…Ø³Ø§Ø¨Ù‚Ø©'}</span>
                            ${entity ? `<span>Ø§Ù„Ø¬Ù‡Ø©: ${entity.entity_name}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn" style="flex: 1;" onclick="startQuiz('${quiz.id}')">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
                            <button class="btn btn-secondary" style="flex: 1; background: #ffc107; color: #333;" onclick="showQuizLeaderboard('${quiz.quiz_title}')">ğŸ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        let currentQuizData = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let savedAnswers = [];
        
        function startQuiz(quizId) {
            currentQuizId = quizId;
            const quiz = allData.find(item => item.id === quizId);
            if (!quiz) return;
            
            currentQuizData = quiz;
            currentQuestionIndex = 0;
            userAnswers = [];
            savedAnswers = [];
            quizStartTime = null;
            clearInterval(quizTimerInterval);
            
            showPage('takeQuizPage');
            
            setTimeout(() => {
                const titleElement = document.getElementById('quizTitle');
                const nameInput = document.getElementById('participantName');
                const questionsContainer = document.getElementById('quizQuestionsContainer');
                const startBtn = document.getElementById('startQuizBtn');
                
                if (titleElement) titleElement.textContent = quiz.quiz_title;
                if (nameInput) nameInput.value = '';
                if (questionsContainer) questionsContainer.innerHTML = '';
                
                if (startBtn) {
                    startBtn.textContent = quiz.quiz_type === 'competition' ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©' : 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                }
                
                const formGroup = document.querySelector('#takeQuizPage .form-group');
                if (formGroup) {
                    formGroup.style.display = 'block';
                }
                
                const existingNameCard = document.getElementById('participantNameCard');
                if (existingNameCard) {
                    existingNameCard.remove();
                }
            }, 10);
        }

        function startQuizQuestions() {
            const participantName = document.getElementById('participantName').value.trim();
            if (!participantName) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹', true);
                return;
            }
            
            quizStartTime = Date.now();
            currentQuestionIndex = 0;
            userAnswers = [];
            const questions = JSON.parse(currentQuizData.questions);
            savedAnswers = new Array(questions.length).fill(null);
            
            const formGroup = document.querySelector('#takeQuizPage .form-group');
            formGroup.style.display = 'none';
            
            const nameCard = document.createElement('div');
            nameCard.id = 'participantNameCard';
            nameCard.innerHTML = `
                <div style="text-align: center; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <p style="margin: 0; font-size: 1.4em; font-weight: bold;">
                        ğŸ‘¤ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚: ${participantName}
                    </p>
                </div>
            `;
            document.getElementById('quizQuestionsContainer').parentElement.insertBefore(nameCard, document.getElementById('quizQuestionsContainer'));
            
            displayCurrentQuestion();
        }

        // ğŸ†• Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù†ØµØ±
        function unselectOrderItem(element) {
            const poolContainer = document.getElementById('ordering_pool_container');
            const answerContainer = document.getElementById('ordering_answer_container');
            const itemText = element.dataset.item;
            
            if (!poolContainer || !answerContainer) return;
            
            // 1. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            element.remove();
            
            // 2. Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            const poolItem = poolContainer.querySelector(`.order-item-pool[data-item="${itemText}"]`);
            if (poolItem) {
                poolItem.style.display = 'block';
            }

            // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            Array.from(answerContainer.children).forEach((child, index) => {
                child.querySelector('span').textContent = `${index + 1}.`;
            });

            // 4. ØªØ´ØºÙŠÙ„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            if (currentQuizData && currentQuizData.quiz_type !== 'competition') {
                saveCurrentAnswer();
                displayCurrentQuestion(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
            }
        }
        
        // ğŸ†• Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨
        function selectOrderItem(element) {
            const answerContainer = document.getElementById('ordering_answer_container');
            const itemText = element.dataset.item;
            
            const totalItems = JSON.parse(currentQuizData.questions)[currentQuestionIndex].correctOrder.length;

            if (answerContainer.children.length >= totalItems) {
                return; // Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø±ØªØ¨
            const orderedItem = document.createElement('div');
            orderedItem.className = 'order-item-selected';
            orderedItem.dataset.item = itemText;
            
            const orderNumber = answerContainer.children.length + 1;

            orderedItem.innerHTML = `<span style="font-weight: bold; color: #667eea; margin-left: 10px;">${orderNumber}.</span> ${itemText}`;
            orderedItem.style.cssText = 'padding: 10px; background: #d4edda; border-radius: 5px; border: 1px solid #28a745; display: flex; align-items: center; cursor: pointer;';
            
            // ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø« (Event Listener) Ø§Ù„Ø¬Ø¯ÙŠØ¯
            orderedItem.addEventListener('click', function() {
                unselectOrderItem(this);
            });

            answerContainer.appendChild(orderedItem);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹
            element.style.display = 'none';
            
            // ØªØ´ØºÙŠÙ„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ (ÙÙŠ ÙˆØ¶Ø¹ Quiz)
            if (currentQuizData && currentQuizData.quiz_type !== 'competition') {
                saveCurrentAnswer();
                displayCurrentQuestion(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
            }
        }

        
        function displayCurrentQuestion() {
            if (!currentQuizData) return;
            
            const questions = JSON.parse(currentQuizData.questions);
            if (currentQuestionIndex >= questions.length) {
                showQuizResults();
                return;
            }
            
            const q = questions[currentQuestionIndex];
            const container = document.getElementById('quizQuestionsContainer');
            const isCompetition = currentQuizData.quiz_type === 'competition';
            
            clearInterval(quizTimerInterval);
            const timerDisplay = document.getElementById('activeTimer');
            if (timerDisplay) timerDisplay.remove();

            // Ø²Ø± Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©)
            let wheelButtonHtml = '';
            if (isCompetition) {
                wheelButtonHtml = `
                    <button class="btn btn-secondary" style="width: auto; padding: 10px 20px; background: #f5576c; margin-bottom: 15px;" onclick="showContestWheelModal()">
                        ğŸ¡ Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
                    </button>
                `;
            }

            if (isCompetition && currentQuizData.time_limit > 0) {
                 startQuestionTimer(currentQuizData.time_limit);
            }
            
            let answersHtml = '';
            
            if (q.type === 'multiple' || q.type === 'truefalse') {
                const options = q.type === 'truefalse' ? ['ØµØ­', 'Ø®Ø·Ø£'] : q.answers;
                answersHtml = options.map((answer, ansIndex) => `
                    <label class="answer-option" style="cursor: pointer;">
                        <input type="radio" name="current_answer" value="${ansIndex}">
                        ${answer}
                    </label>
                `).join('');
            } else if (q.type === 'text') {
                answersHtml = `
                    <div class="form-group">
                        <input type="text" id="text_answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§" style="width: 100%;">
                    </div>
                `;
            } else if (q.type === 'checkbox') {
                answersHtml = q.answers.map((answer, ansIndex) => `
                    <label class="answer-option" style="cursor: pointer;">
                        <input type="checkbox" class="checkbox_answer" value="${ansIndex}">
                        ${answer}
                    </label>
                `).join('');
            } else if (q.type === 'matching') {
                const uniqueRight = [...new Set(q.pairs.map(p => p.right))];
                const shuffledRight = [...uniqueRight].sort(() => Math.random() - 0.5);
                answersHtml = `
                    <div style="display: grid; gap: 15px;">
                        ${q.pairs.map((pair, i) => `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="flex: 1; padding: 10px; background: #f8f9fa; border-radius: 5px;">${pair.left}</span>
                                <span style="margin: 0 10px;">âŸ·</span>
                                <select class="matching_answer" data-index="${i}" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                    <option value="">-- Ø§Ø®ØªØ± --</option>
                                    ${shuffledRight.map((right, j) => `<option value="${right}">${right}</option>`).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (q.type === 'ordering') {
                // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„ (Click-to-Order)
                const shuffledItems = [...q.correctOrder].sort(() => Math.random() - 0.5);
                
                const shuffledHtml = shuffledItems.map((item, i) => `
                    <div class="order-item-pool" data-item="${item}" onclick="selectOrderItem(this)" 
                         style="padding: 15px; background: #e3f2fd; border-radius: 5px; cursor: pointer; border: 1px solid #90caf9; margin-bottom: 10px; transition: all 0.2s; font-weight: bold;">
                        ${item}
                    </div>
                `).join('');

                answersHtml = `
                    <p style="margin-bottom: 10px; font-weight: bold; color: #333;">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:</p>
                    
                    <div id="ordering_pool_container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 15px; background: #f0f0f0; border-radius: 10px; margin-bottom: 20px;">
                        ${shuffledHtml}
                    </div>

                    <p style="margin-bottom: 10px; font-weight: bold; color: #667eea;">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø© (Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹):</p>
                    <div id="ordering_answer_container" style="display: flex; flex-direction: column; gap: 8px; padding: 15px; background: white; border: 2px dashed #667eea; border-radius: 10px; min-height: 100px;">
                        </div>
                `;
            }
            
            const navigationHtml = isCompetition ? '' : `
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    ${questions.map((_, i) => `
                        <button onclick="navigateToQuestion(${i})" 
                                style="width: 45px; height: 45px; border-radius: 8px; border: 2px solid ${i === currentQuestionIndex ? '#667eea' : '#e0e0e0'}; 
                                background: ${savedAnswers[i] !== null ? '#d4edda' : (i === currentQuestionIndex ? '#667eea' : 'white')}; 
                                color: ${i === currentQuestionIndex ? 'white' : '#333'}; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                            ${i + 1}
                        </button>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = `
                ${navigationHtml}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="padding: 15px; background: #f0f0f0; border-radius: 10px; text-align: center; flex: 1;">
                        <strong>Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${questions.length}</strong>
                    </div>
                    ${wheelButtonHtml}
                </div>
                <div class="question-item">
                    <h4>${q.question}</h4>
                    ${answersHtml}
                    <div id="feedback_area" style="margin-top: 15px;"></div>
                    <button class="btn btn-success" style="margin-top: 20px;" onclick="${isCompetition ? 'submitCompetitionAnswer()' : 'submitQuizAnswer()'}">
                        ${isCompetition ? (currentQuestionIndex < questions.length - 1 ? 'ØªØ³Ù„ÙŠÙ… ÙˆØ¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©' : 'ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©') : (currentQuestionIndex < questions.length - 1 ? 'Ø­ÙØ¸ ÙˆØ§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ' : 'Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±')}
                    </button>
                </div>
            `;
            
            
            restoreSavedAnswer();
        }
        
        function startQuestionTimer(seconds) {
            clearInterval(quizTimerInterval); 
            
            const qItem = document.querySelector('.question-item');
            if (!qItem) return;

            let timeLeft = parseInt(seconds);
            
            const timerHTML = `
                <div id="activeTimer" style="margin-bottom: 15px; padding: 10px; background: #fefefe; border-radius: 8px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                        <span style="font-weight:bold; color:#333;">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> 
                        <span id="timeCount" style="font-weight:bold; font-size:1.2em; color:#dc3545;">${timeLeft}</span> Ø«Ø§Ù†ÙŠØ©
                    </div>
                    <div style="width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px;">
                        <div id="progressBar" style="width: 100%; height: 100%; background-color: #28a745; border-radius: 5px; transition: width 1s linear;"></div>
                    </div>
                </div>
            `;
            
            const timerDiv = document.createElement('div');
            timerDiv.innerHTML = timerHTML;
            qItem.insertBefore(timerDiv.firstChild, qItem.firstChild);

            quizTimerInterval = setInterval(() => {
                timeLeft--;
                const timeCountEl = document.getElementById('timeCount');
                if(timeCountEl) timeCountEl.innerText = timeLeft;
                
                const percentage = (timeLeft / seconds) * 100;
                const bar = document.getElementById('progressBar');
                if(bar) {
                    bar.style.width = percentage + "%";
                    if(percentage < 30) bar.style.backgroundColor = "#dc3545"; 
                }

                if (timeLeft <= 0) {
                    clearInterval(quizTimerInterval);
                    showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø© ÙØ§Ø±ØºØ©.', true);
                    forceSubmitTimeout(); 
                }
            }, 1000);
        }
        
        function forceSubmitTimeout() {
            savedAnswers[currentQuestionIndex] = null;
            userAnswers.push({
                question: JSON.parse(currentQuizData.questions)[currentQuestionIndex].question,
                type: JSON.parse(currentQuizData.questions)[currentQuestionIndex].type,
                userAnswer: null, 
                isCorrect: false,
                partialScore: 0
            });
            
            currentQuestionIndex++;
            displayCurrentQuestion();
        }


        function restoreSavedAnswer() {
            const questions = JSON.parse(currentQuizData.questions);
            const q = questions[currentQuestionIndex];
            const savedAnswer = savedAnswers[currentQuestionIndex];
            
            if (savedAnswer === null) return;
            
            if (q.type === 'multiple' || q.type === 'truefalse') {
                const radio = document.querySelector(`input[name="current_answer"][value="${savedAnswer}"]`);
                if (radio) radio.checked = true;
            } else if (q.type === 'text') {
                const textInput = document.getElementById('text_answer');
                if (textInput) textInput.value = savedAnswer;
            } else if (q.type === 'checkbox') {
                savedAnswer.forEach(val => {
                    const checkbox = document.querySelector(`.checkbox_answer[value="${val}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            } else if (q.type === 'matching') {
                const selects = document.querySelectorAll('.matching_answer');
                savedAnswer.forEach((val, i) => {
                    if (selects[i]) selects[i].value = val;
                });
            } else if (q.type === 'ordering') {
                // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© Click-to-Order
                const answerContainer = document.getElementById('ordering_answer_container');
                const poolContainer = document.getElementById('ordering_pool_container');
                
                if (savedAnswer && savedAnswer.length > 0 && answerContainer && poolContainer) {
                    answerContainer.innerHTML = '';
                    
                    savedAnswer.forEach((item, index) => {
                        // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                        const orderedItem = document.createElement('div');
                        orderedItem.className = 'order-item-selected';
                        orderedItem.dataset.item = item;
                        const orderNumber = index + 1;
                        orderedItem.innerHTML = `<span style="font-weight: bold; color: #667eea; margin-left: 10px;">${orderNumber}.</span> ${item}`;
                        orderedItem.style.cssText = 'padding: 10px; background: #d4edda; border-radius: 5px; border: 1px solid #28a745; display: flex; align-items: center; cursor: pointer;';
                        
                        // ğŸ†• Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø­Ø¯Ø«
                        orderedItem.addEventListener('click', function() {
                            unselectOrderItem(this);
                        });
                        answerContainer.appendChild(orderedItem);
                        
                        // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                        const poolItem = poolContainer.querySelector(`.order-item-pool[data-item="${item}"]`);
                        if (poolItem) {
                            poolItem.style.display = 'none';
                        }
                    });
                }
            }
        }
        
        function navigateToQuestion(index) {
            saveCurrentAnswer();
            currentQuestionIndex = index;
            displayCurrentQuestion();
        }
        
        function saveCurrentAnswer() {
            const questions = JSON.parse(currentQuizData.questions);
            const q = questions[currentQuestionIndex];
            
            let answer = null;
            
            if (q.type === 'multiple' || q.type === 'truefalse') {
                const selected = document.querySelector('input[name="current_answer"]:checked');
                if (selected) {
                    answer = q.type === 'truefalse' ? (selected.value === '0') : parseInt(selected.value);
                }
            } else if (q.type === 'text') {
                const textInput = document.getElementById('text_answer');
                if (textInput && textInput.value.trim()) {
                    answer = textInput.value.trim();
                }
            } else if (q.type === 'checkbox') {
                const checked = document.querySelectorAll('.checkbox_answer:checked');
                if (checked.length > 0) {
                    answer = Array.from(checked).map(c => parseInt(c.value));
                }
            } else if (q.type === 'matching') {
                const selects = document.querySelectorAll('.matching_answer');
                const allAnswers = Array.from(selects).map(s => s.value);
                if (allAnswers.every(a => a !== '')) {
                    answer = allAnswers;
                }
            } else if (q.type === 'ordering') {
                // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø­Ø§ÙˆÙŠØ© Click-to-Order
                const orderedItems = document.querySelectorAll('#ordering_answer_container .order-item-selected');
                
                if (orderedItems.length > 0) {
                    answer = Array.from(orderedItems).map(item => item.dataset.item);
                }
            }
            
            savedAnswers[currentQuestionIndex] = answer;
        }
        
        function setupDragAndDrop() {
            // Ù„Ù… ÙŠØ¹Ø¯ ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨
        }
        
        function submitQuizAnswer() {
            saveCurrentAnswer();
            
            const savedAnswer = savedAnswers[currentQuestionIndex];
            const questions = JSON.parse(currentQuizData.questions);
            const q = questions[currentQuestionIndex];

            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            if (q.type === 'ordering') {
                if (!savedAnswer || savedAnswer.length !== q.correctOrder.length) {
                     showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨.', true);
                     return;
                }
            } else if (savedAnswer === null) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„', true);
                return;
            }
            
            
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            } else {
                for (let i = 0; i < questions.length; i++) {
                    const qCheck = questions[i];
                    if (savedAnswers[i] === null || (qCheck.type === 'ordering' && savedAnswers[i].length !== qCheck.correctOrder.length)) {
                        showToast(`ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}`, true);
                        currentQuestionIndex = i;
                        displayCurrentQuestion();
                        return;
                    }
                }
                
                userAnswers = questions.map((q, i) => ({
                    question: q.question,
                    type: q.type,
                    userAnswer: savedAnswers[i],
                    correctAnswer: q.correct || q.correctOrder || q.pairs,
                    isCorrect: null, 
                    partialScore: null
                }));
                
                showQuizResults();
            }
        }
        
        function submitCompetitionAnswer() {
            clearInterval(quizTimerInterval);
            
            const questions = JSON.parse(currentQuizData.questions);
            const q = questions[currentQuestionIndex];
            
            let userAnswer = null;
            let isCorrect = false;
            let partialScore = 0;
            
            if (q.type === 'multiple' || q.type === 'truefalse') {
                const selected = document.querySelector('input[name="current_answer"]:checked');
                if (!selected) { showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø©', true); return; }
                userAnswer = q.type === 'truefalse' ? (selected.value === '0') : parseInt(selected.value);
                isCorrect = userAnswer === q.correct || (q.type === 'truefalse' && userAnswer === q.correct);
                partialScore = isCorrect ? 1 : 0;
                
                if (isCorrect) {
                    const celebrations = [{ emoji: 'ğŸ‰', message: 'Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' }, { emoji: 'ğŸŒŸ', message: 'Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ø£Ø­Ø³Ù†Øª!' }, { emoji: 'ğŸ†', message: 'Ù…Ø°Ù‡Ù„! Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©!' }];
                    showCelebration('success', celebrations[Math.floor(Math.random() * celebrations.length)].message, celebrations[Math.floor(Math.random() * celebrations.length)].emoji);
                } else { showCelebration('wrong', 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¯Ù†Ø§Ù‡.', 'âŒ'); }
                
            } else if (q.type === 'text') {
                userAnswer = document.getElementById('text_answer').value.trim();
                if (!userAnswer) { showToast('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©', true); return; }
                const normalizedUserAnswer = normalizeArabicText(userAnswer);
                const normalizedCorrectAnswer = normalizeArabicText(q.correct);
                isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
                const similarity = calculateSimilarity(normalizedUserAnswer, normalizedCorrectAnswer);
                
                if (isCorrect) {
                    partialScore = 1;
                    const celebrations = [{ emoji: 'ğŸ‰', message: 'Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' }, { emoji: 'ğŸŒŸ', message: 'Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ø£Ø­Ø³Ù†Øª!' }, { emoji: 'ğŸ†', message: 'Ù…Ø°Ù‡Ù„! Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©!' }];
                    showCelebration('success', celebrations[Math.floor(Math.random() * celebrations.length)].message, celebrations[Math.floor(Math.random() * celebrations.length)].emoji);
                } else if (similarity > 0.7) {
                    partialScore = 0.5; showCelebration('close', 'Ù„Ù‚Ø¯ Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©!', 'ğŸ˜Š');
                } else { partialScore = 0; showCelebration('wrong', 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¯Ù†Ø§Ù‡.', 'ğŸ’ª'); }
                
            } else if (q.type === 'checkbox') {
                const checked = document.querySelectorAll('.checkbox_answer:checked');
                if (checked.length === 0) { showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', true); return; }
                userAnswer = Array.from(checked).map(c => parseInt(c.value)).sort();
                const correctAnswers = q.correct.sort();
                const totalCorrect = correctAnswers.length;
                const correctSelected = userAnswer.filter(ans => correctAnswers.includes(ans)).length;
                const wrongSelected = userAnswer.filter(ans => !correctAnswers.includes(ans)).length;
                
                if (correctSelected === wrongSelected && userAnswer.length === totalCorrect) { partialScore = 0; } 
                else { partialScore = Math.max(0, (correctSelected - wrongSelected) / totalCorrect); }
                isCorrect = JSON.stringify(userAnswer) === JSON.stringify(correctAnswers);
                
                if (isCorrect) {
                    const celebrations = [{ emoji: 'ğŸ‰', message: 'Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' }, { emoji: 'âœ¨', message: 'Ø¹Ø¸ÙŠÙ…! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ…ÙŠØ²!' },];
                    showCelebration('success', celebrations[Math.floor(Math.random() * celebrations.length)].message, celebrations[Math.floor(Math.random() * celebrations.length)].emoji);
                } else if (partialScore > 0.5) { showCelebration('close', 'Ø¥Ø¬Ø§Ø¨Ø© Ø¬ÙŠØ¯Ø©! Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„ØµØ­ÙŠØ­Ø©.', 'ğŸ‘'); } 
                else { showCelebration('wrong', 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¯Ù†Ø§Ù‡.', 'ğŸ’ª'); }
                
            } else if (q.type === 'matching') {
                const selects = document.querySelectorAll('.matching_answer');
                userAnswer = [];
                for (let select of selects) { if (!select.value) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª', true); return; } userAnswer.push(select.value); }
                const correctMatches = userAnswer.filter((ans, i) => ans === q.pairs[i].right).length;
                partialScore = correctMatches / q.pairs.length;
                isCorrect = userAnswer.every((ans, i) => ans === q.pairs[i].right);
                
                if (isCorrect) { showCelebration('success', 'Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹ ÙÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©!', 'ğŸ¥³'); } 
                else if (partialScore > 0.5) { showCelebration('close', 'Ø£Ø­Ø³Ù†Øª! Ø¬Ø²Ø¡ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­.', 'ğŸ™‚'); } 
                else { showCelebration('wrong', 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¯Ù†Ø§Ù‡.', 'ğŸ’ª'); }
                
            } else if (q.type === 'ordering') {
                // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ (Click-to-Order)
                const orderedItems = document.querySelectorAll('#ordering_answer_container .order-item-selected');
                const totalItems = q.correctOrder.length;
                
                if (orderedItems.length !== totalItems) {
                    showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨.', true);
                    return;
                }
                
                userAnswer = Array.from(orderedItems).map(item => item.dataset.item);
                
                let correctPositions = 0;
                userAnswer.forEach((item, i) => { 
                    if (item === q.correctOrder[i]) correctPositions++; 
                });
                
                partialScore = correctPositions / totalItems;
                isCorrect = JSON.stringify(userAnswer) === JSON.stringify(q.correctOrder);
                
                if (isCorrect) { showCelebration('success', 'Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ø«Ø§Ù„ÙŠ!', 'ğŸ‘'); } 
                else if (partialScore > 0.5) { showCelebration('close', 'Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­.', 'ğŸ¤”'); } 
                else { showCelebration('wrong', 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£Ø¯Ù†Ø§Ù‡.', 'ğŸ’ª'); }
            }
            
            const feedbackArea = document.getElementById('feedback_area');
            let correctAnswerText = '';
            if (q.type === 'multiple') { correctAnswerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ${q.answers[q.correct]}`; } 
            else if (q.type === 'truefalse') { correctAnswerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ${q.correct ? 'ØµØ­' : 'Ø®Ø·Ø£'}`; } 
            else if (q.type === 'text') { correctAnswerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ${q.correct}`; } 
            else if (q.type === 'checkbox') { correctAnswerText = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ${q.correct.map(i => q.answers[i]).join(' ØŒ ')}`; } 
            else if (q.type === 'matching') { correctAnswerText = 'Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©: ' + q.pairs.map(p => `${p.left} âŸ· ${p.right}`).join(' | '); } 
            else if (q.type === 'ordering') { correctAnswerText = `Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠ: ${q.correctOrder.join(' â† ')}`; }

            if (isCorrect) {
                feedbackArea.innerHTML = '<div style="padding: 15px; background: #d4edda; color: #155724; border-radius: 8px; font-weight: bold;">âœ“ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!</div>';
            } else if (partialScore > 0) {
                feedbackArea.innerHTML = `<div style="padding: 15px; background: #fff3cd; color: #856404; border-radius: 8px;">â— Ø¥Ø¬Ø§Ø¨Ø© Ø¬Ø²Ø¦ÙŠØ© ØµØ­ÙŠØ­Ø© (${(partialScore * 100).toFixed(0)}%)<br><strong>${correctAnswerText}</strong></div>`;
            } else {
                feedbackArea.innerHTML = `<div style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 8px;">âœ— Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©<br><strong>${correctAnswerText}</strong></div>`;
            }
            
            userAnswers.push({
                question: q.question, type: q.type, userAnswer: userAnswer,
                correctAnswer: q.correct || q.correctOrder || q.pairs,
                isCorrect: isCorrect, partialScore: partialScore
            });
            
            document.querySelectorAll('input, select').forEach(el => { el.disabled = true; });
            
            const btn = document.querySelector('.question-item button');
            btn.disabled = false;
            btn.classList.remove('btn-success');
            btn.classList.add('btn');
            btn.textContent = currentQuestionIndex < questions.length - 1 ? 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©';
            btn.onclick = () => { currentQuestionIndex++; displayCurrentQuestion(); };
        }
        
        async function showQuizResults() {
            clearInterval(quizTimerInterval);

            if (allData.length >= 999) { showToast('ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª (999)', true); return; }

            const participantName = document.getElementById('participantName').value;
            const questions = JSON.parse(currentQuizData.questions);
            const isCompetition = currentQuizData.quiz_type === 'competition';
            
            let score = 0;
            
            if (isCompetition) {
                score = userAnswers.reduce((sum, a) => sum + (a.partialScore || 0), 0);
            } else {
                userAnswers.forEach((answer, index) => {
                    const q = questions[index];
                    let questionScore = 0;
                    
                    if (q.type === 'multiple' || q.type === 'truefalse') {
                        if (answer.userAnswer === q.correct) questionScore = 1;
                    } else if (q.type === 'text') {
                        const normalizedUserAnswer = normalizeArabicText(answer.userAnswer);
                        const normalizedCorrectAnswer = normalizeArabicText(q.correct);
                        if (normalizedUserAnswer === normalizedCorrectAnswer) questionScore = 1;
                    } else if (q.type === 'checkbox') {
                        const correctAnswers = q.correct;
                        const userAnswersArr = answer.userAnswer || [];
                        const totalCorrect = correctAnswers.length;
                        const correctSelected = userAnswersArr.filter(ans => correctAnswers.includes(ans)).length;
                        const wrongSelected = userAnswersArr.filter(ans => !correctAnswers.includes(ans)).length;
                        
                        if (correctSelected === wrongSelected && userAnswersArr.length === totalCorrect) { questionScore = 0; } 
                        else { questionScore = Math.max(0, (correctSelected - wrongSelected) / totalCorrect); }
                    } else if (q.type === 'matching') {
                        const correctMatches = answer.userAnswer.filter((ans, i) => ans === q.pairs[i].right).length;
                        questionScore = correctMatches / q.pairs.length;
                    } else if (q.type === 'ordering') {
                        // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Quiz)
                        let correctPositions = 0;
                        if (answer.userAnswer && q.correctOrder) {
                            answer.userAnswer.forEach((item, i) => { if (item === q.correctOrder[i]) correctPositions++; });
                        }
                        questionScore = correctPositions / q.correctOrder.length;
                    }
                    score += questionScore;
                    answer.isCorrect = questionScore >= 0.99;
                    answer.partialScore = questionScore;
                });
            }
            
            const timeTaken = Math.floor((Date.now() - quizStartTime) / 1000);
            
            const result = await window.dataSdk.create({
                id: 'result_' + Date.now(), type: 'result', entity_id: currentQuizData.entity_id,
                quiz_title: currentQuizData.quiz_title, participant_name: participantName,
                score: score, time_taken: timeTaken, completed_at: Date.now(),
                user_answers: JSON.stringify(userAnswers)
            });
            
            if (result.isOk) { displayResultsSummary(score, questions.length); } 
            else { showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©', true); }
        }
        
        function displayResultsSummary(score, total) {
            const questions = JSON.parse(currentQuizData.questions);
            const container = document.getElementById('quizQuestionsContainer');
            const isCompetition = currentQuizData.quiz_type === 'competition';
            
            const percentage = (score / total) * 100;
            const hasCert = currentQuizData.enable_cert || false;
            
            let certButtonHtml = '';
            if (hasCert && percentage >= 50) {
                certButtonHtml = `
                    <button class="btn btn-success" style="margin-top: 20px; padding: 15px 40px; background: #ffd700; color: #333; font-size: 1.1em; font-weight: bold;" 
                    onclick="generateCertificatePDF('${document.getElementById('participantName').value}', '${currentQuizData.quiz_title}', '${score.toFixed(2)}/${total}')">
                    ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥ØªÙ…Ø§Ù…
                    </button>
                `;
            }
            
            let summaryHtml = `
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0; font-size: 2.5em;">ğŸ‰ ${isCompetition ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©' : 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'}!</h2>
                    <p style="font-size: 2em; margin: 0; font-weight: bold;">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${score.toFixed(2)} Ù…Ù† ${total}</p>
                    <p style="font-size: 1.2em; margin: 10px 0 0 0;">${isCompetition ? 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„' : 'Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­'}: ${Math.round(percentage)}%</p>
                    ${certButtonHtml}
                </div>
                
                <h3 style="margin-bottom: 20px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</h3>
            `;
            
            userAnswers.forEach((answer, index) => {
                const q = questions[index];
                const isCorrect = answer.isCorrect || false;
                const partialScore = answer.partialScore || 0;
                let correctAnswerText = '';
                let userAnswerText = answer.userAnswer !== null && answer.userAnswer !== undefined ? (answer.userAnswer.join ? answer.userAnswer.join(' ØŒ ') : answer.userAnswer) : '<span style="color: #999;">Ù„Ù… ÙŠØ¬Ø¨/Ø£Ø¬Ø§Ø¨Ø© ÙØ§Ø±ØºØ©</span>';
                
                if (q.type === 'multiple') {
                    userAnswerText = answer.userAnswer !== null && answer.userAnswer !== undefined ? q.answers[answer.userAnswer] : userAnswerText;
                    correctAnswerText = q.answers[q.correct];
                } else if (q.type === 'truefalse') {
                    userAnswerText = answer.userAnswer !== null && answer.userAnswer !== undefined ? (answer.userAnswer ? 'ØµØ­' : 'Ø®Ø·Ø£') : userAnswerText;
                    correctAnswerText = q.correct ? 'ØµØ­' : 'Ø®Ø·Ø£';
                } else if (q.type === 'text') { correctAnswerText = q.correct; } 
                else if (q.type === 'checkbox') {
                    userAnswerText = answer.userAnswer && answer.userAnswer.length > 0 ? answer.userAnswer.map(i => q.answers[i]).join(' ØŒ ') : userAnswerText;
                    correctAnswerText = q.correct.map(i => q.answers[i]).join(' ØŒ ');
                } else if (q.type === 'matching') {
                    userAnswerText = answer.userAnswer && answer.userAnswer.length > 0 ? q.pairs.map((p, i) => `${p.left} âŸ· ${answer.userAnswer[i]}`).join(' | ') : userAnswerText;
                    correctAnswerText = q.pairs.map(p => `${p.left} âŸ· ${p.right}`).join(' | ');
                } else if (q.type === 'ordering') {
                    userAnswerText = answer.userAnswer && answer.userAnswer.length > 0 ? answer.userAnswer.join(' â† ') : userAnswerText;
                    correctAnswerText = q.correctOrder.join(' â† ');
                }
                
                const bgColor = isCorrect ? '#d4edda' : (partialScore > 0 ? '#fff3cd' : '#f8d7da');
                const borderColor = isCorrect ? '#28a745' : (partialScore > 0 ? '#ffc107' : '#dc3545');
                const icon = isCorrect ? 'âœ“' : (partialScore > 0 ? 'â—' : 'âœ—');
                
                summaryHtml += `
                    <div style="padding: 20px; background: ${bgColor}; border-radius: 10px; margin-bottom: 15px; border-right: 5px solid ${borderColor};">
                        <h4 style="margin: 0 0 10px 0;">${icon} Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}: ${q.question}</h4>
                        <p style="margin: 5px 0;"><strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${userAnswerText}</p>
                        <p style="margin: 5px 0; color: #666;"><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> ${partialScore.toFixed(2)}/1</p>
                        ${!isCorrect ? `<p style="margin: 5px 0; color: #155724;"><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</strong> ${correctAnswerText}</p>` : ''}
                    </div>
                `;
            });
            
            summaryHtml += `<button class="btn" style="margin-top: 20px;" onclick="goBackToQuizzes()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</button>`;
            container.innerHTML = summaryHtml;
        }
        
        function generateCertificatePDF(studentName, courseName, score) {
            const { jsPDF } = window.jspdf;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØµØµØ©
            let quiz = allData.find(q => q.quiz_title === courseName && q.entity_id === currentEntityId);
            if (!quiz) {
                 quiz = currentQuizData || {}; // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ ÙƒØ§Ù…Ù„
            }

            const certTitle = quiz.cert_title || 'Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…';
            const certBody = quiz.cert_body || 'ØªØ´Ù‡Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø£Ù†';
            const certBg = quiz.cert_bg; // Base64 image
            
            const passingScore = score.split('/')[1] * 0.5;
            
            const certDiv = document.createElement('div');
            certDiv.id = 'cert-container';
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ©
            let bgStyle = 'background: white;';
            if (certBg) {
                bgStyle = `background: url('${certBg}') no-repeat center center; background-size: cover;`;
            }

            certDiv.style.cssText = `
                position: fixed; top: -9999px; left: 0; width: 800px; height: 600px; 
                padding: 50px; text-align: center; border: 10px solid #667eea; 
                ${bgStyle}
                font-family: 'Arial', sans-serif; z-index: 9999;
                display: flex; flex-direction: column; justify-content: center; align-items: center;
                direction: rtl; 
            `;
            
            const date = new Date().toLocaleDateString('ar-SA');
            
            // ØªØ­Ø³ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Øµ ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø®Ù„ÙÙŠØ© (Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ù„Ù„Ù†Øµ)
            const textShadow = certBg ? 'text-shadow: 2px 2px 4px rgba(255,255,255,0.8);' : '';
            
            certDiv.innerHTML = `
                <h1 style="color: #667eea; font-size: 50px; margin-bottom: 20px; ${textShadow}">${certTitle}</h1>
                <p style="font-size: 24px; color: #333; font-weight:bold; ${textShadow}">${certBody}</p>
                <h2 style="font-size: 40px; color: #000; margin: 10px 0; padding: 5px 20px; border-bottom: 2px dashed #764ba2; ${textShadow}">${studentName}</h2>
                <p style="font-size: 24px; color: #333; font-weight:bold; ${textShadow}">Ù‚Ø¯ Ø§Ø¬ØªØ§Ø² Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ù†ÙˆØ§Ù†</p>
                <h3 style="font-size: 30px; color: #764ba2; ${textShadow}">"${courseName}"</h3>
                <p style="font-size: 20px; margin-top: 20px; color: #333; font-weight:bold; ${textShadow}">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score}</p>
                <p style="font-size: 18px; margin-top: 40px; color: #333; font-weight:bold; ${textShadow}">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø­: ${date}</p>
            `;
            
            document.body.appendChild(certDiv);

            html2canvas(certDiv, { scale: 2, useCORS: true }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'px', [800, 600]);
                pdf.addImage(imgData, 'PNG', 0, 0, 800, 600);
                pdf.save(`Ø´Ù‡Ø§Ø¯Ø©_${studentName}.pdf`);
                document.body.removeChild(certDiv);
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            });
        }
        
        function importRandomQuestions() {
            const count = parseInt(document.getElementById('importCount').value);
            if (!count || count <= 0) { showToast('Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ Ù„Ù„Ø£Ø³Ø¦Ù„Ø©', true); return; }

            let allPoolQuestions = [];
            const myQuizzes = allData.filter(item => item.type === 'quiz' && item.entity_id === currentEntityId);

            myQuizzes.forEach(quiz => {
                try {
                    const qList = JSON.parse(quiz.questions);
                    allPoolQuestions = allPoolQuestions.concat(qList);
                } catch (e) { console.error(e); }
            });

            if (allPoolQuestions.length === 0) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù†Ù‡Ø§', true); return; }

            allPoolQuestions.sort(() => Math.random() - 0.5);
            const selectedQuestions = allPoolQuestions.slice(0, count);
            if (selectedQuestions.length < count) { showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${selectedQuestions.length} Ø³Ø¤Ø§Ù„ ÙÙ‚Ø·. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯.`, true); }

            selectedQuestions.forEach(q => {
                addQuestionForm();
                const lastQIndex = questionCounter;
                document.getElementById(`qtype_${lastQIndex}`).value = q.type;
                document.getElementById(`qtext_${lastQIndex}`).value = q.question;
                
                updateQuestionType(`question_${lastQIndex}`);
                updateQuestionTypeWithData(`question_${lastQIndex}`, q);
            });

            showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${selectedQuestions.length} Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­`);
        }


        function goBackToQuizzes() {
            if (currentEntityId) { showQuizzesSection(); } else { showPublicQuizzes(); }
        }

        // ğŸŸ¢ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
        function showQuizLeaderboard(quizTitle) {
            const results = allData.filter(item => 
                item.type === 'result' && 
                (currentEntityId ? item.entity_id === currentEntityId : true) && 
                item.quiz_title === quizTitle
            );

            document.getElementById('leaderboardBackBtn').onclick = currentEntityId ? showQuizzesSection : goToHome;
            document.getElementById('leaderboardSubtitle').textContent = `Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø©: ${quizTitle}`;
            
            renderSpecificLeaderboard(results);
            showPage('leaderboardPage');
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ø±Ø© (ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ù…Ø®ØµØµ)
        function renderSpecificLeaderboard(results) {
            const tbody = document.getElementById('leaderboardBody');
            results.sort((a, b) => b.score - a.score || a.time_taken - b.time_taken);
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</td></tr>';
                return;
            }
            
            tbody.innerHTML = results.map((result, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${result.participant_name}</td>
                    <td>${result.quiz_title}</td>
                    <td>${result.score.toFixed(2)}</td>
                    <td>${result.time_taken}</td>
                </tr>
            `).join('');
        }

        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© showPublicLeaderboard
        
        function showWheelOfFortune() { showPage('wheelPage'); parseNames(); }

        let names = [];
        let isSpinning = false;
        let currentRotation = 0;
        let currentWinner = null;
        let canvas = null;
        let ctx = null;
        const wheelColors = ['#81c784', '#64b5f6', '#ffb74d', '#e57373', '#ba68c8', '#4db6ac', '#ff8a65', '#9575cd'];
        
        // ---- Ø¯ÙˆØ§Ù„ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„Ø¹Ø§Ù…Ø© ----
        function initWheel() {
            canvas = document.getElementById('wheelCanvas');
            if (canvas) {
                ctx = canvas.getContext('2d');
                const namesTextarea = document.getElementById('namesTextarea');
                const spinButton = document.getElementById('spinButton');
                const closeModal = document.getElementById('closeModal');
                const deleteWinnerBtn = document.getElementById('deleteWinner');
                
                if (namesTextarea) namesTextarea.addEventListener('input', parseNames);
                if (spinButton) spinButton.addEventListener('click', spinWheel);
                
                if (closeModal) closeModal.onclick = () => { document.getElementById('winnerModal').classList.remove('show'); };
                if (deleteWinnerBtn) deleteWinnerBtn.onclick = () => {
                    if (currentWinner) {
                        const textarea = document.getElementById('namesTextarea');
                        const currentNames = textarea.value.split('\n').filter(n => n.trim());
                        const indexToRemove = currentNames.findIndex(n => n.trim() === currentWinner.trim());
                        if (indexToRemove !== -1) { currentNames.splice(indexToRemove, 1); }
                        textarea.value = currentNames.join('\n');
                        parseNames();
                        currentWinner = null;
                        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§Ø¦Ø² Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
                    }
                    document.getElementById('winnerModal').classList.remove('show');
                };

                parseNames(); 
            }
        }
        
        function parseNames() {
            const textarea = document.getElementById('namesTextarea');
            if (!textarea) return;
            const text = textarea.value.trim();
            if (!text) {
                names = [];
            } else {
                names = text.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            }
            drawWheel();
            updateSpinButton();
        }

        function drawWheel() {
            if (!ctx || !canvas) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (names.length === 0) {
                ctx.fillStyle = '#f0f0f0'; ctx.beginPath(); ctx.arc(200, 200, 192, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#999'; ctx.font = '18px Arial'; ctx.textAlign = 'center'; ctx.fillText('Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ù„Ù„Ø¨Ø¯Ø¡', 200, 200);
                return;
            }

            const anglePerSegment = (Math.PI * 2) / names.length;
            const startOffset = -Math.PI / 2;
            
            names.forEach((name, index) => {
                const startAngle = startOffset + (anglePerSegment * index);
                const endAngle = startAngle + anglePerSegment;
                
                ctx.fillStyle = wheelColors[index % wheelColors.length];
                ctx.beginPath(); ctx.arc(200, 200, 192, startAngle, endAngle); ctx.lineTo(200, 200); ctx.fill();
                
                ctx.save();
                ctx.translate(200, 200);
                ctx.rotate(startAngle + anglePerSegment / 2);
                ctx.textAlign = 'right'; ctx.fillStyle = '#ffffff'; ctx.font = 'bold 18px Arial';
                ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 3;
                ctx.fillText(name.length > 12 ? name.substring(0, 12) + '...' : name, 170, 10);
                ctx.restore();
            });
        }

        function updateSpinButton() {
            const spinButton = document.getElementById('spinButton');
            if (spinButton) { spinButton.disabled = names.length < 2 || isSpinning; }
        }

        function spinWheel() {
            if (isSpinning || names.length < 2) return;
            isSpinning = true;
            const spinButton = document.getElementById('spinButton');
            spinButton.classList.add('spinning');
            updateSpinButton();

            canvas.style.transition = 'none';
            currentRotation = currentRotation % 360; 
            canvas.style.transform = `rotate(${currentRotation}deg)`;
            void canvas.offsetWidth;
            
            const spins = 5 + Math.random() * 3;
            const extraDegrees = Math.random() * 360;
            const totalRotation = currentRotation + spins * 360 + extraDegrees;
            
            canvas.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
            canvas.style.transform = `rotate(${totalRotation}deg)`;
            
            currentRotation = totalRotation;

            setTimeout(() => {
                const finalRotation = currentRotation % 360;
                const anglePerSegment = 360 / names.length;
                let normalizedAngle = (360 - finalRotation) % 360; 
                if (normalizedAngle < 0) normalizedAngle += 360;

                const winnerIndex = Math.floor(normalizedAngle / anglePerSegment) % names.length;
                const winner = names[winnerIndex];

                showWinner(winner);
                createConfetti();

                isSpinning = false;
                spinButton.classList.remove('spinning');
                updateSpinButton();
                
            }, 4000);
        }
        // ---- Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø§Ù„Ø¹Ø§Ù…Ø© ----

        // ---- Ø¯ÙˆØ§Ù„ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ----
        let contestWheelCanvas = null;
        let contestWheelCtx = null;
        let contestWheelNames = [];
        let contestIsSpinning = false;
        let contestCurrentRotation = 0;
        
        function initContestWheel() {
            contestWheelCanvas = document.getElementById('contestWheelCanvas');
            contestWheelCtx = contestWheelCanvas ? contestWheelCanvas.getContext('2d') : null;

            const spinButton = document.getElementById('contestSpinButton');
            if (spinButton) {
                spinButton.addEventListener('click', spinContestWheel);
            }
        }

        function updateContestWheelNames() {
            const textarea = document.getElementById('contestNamesTextarea');
            if (!textarea) return;
            const text = textarea.value.trim();
            contestWheelNames = text.split('\n').map(name => name.trim()).filter(name => name.length > 0);
            drawContestWheel();
            document.getElementById('contestSpinButton').disabled = contestWheelNames.length < 2 || contestIsSpinning;
        }
        
        function drawContestWheel() {
            if (!contestWheelCtx || !contestWheelCanvas) return;
            const size = contestWheelCanvas.width;
            contestWheelCtx.clearRect(0, 0, size, size);
            
            if (contestWheelNames.length === 0) {
                contestWheelCtx.fillStyle = '#f0f0f0'; contestWheelCtx.beginPath(); contestWheelCtx.arc(size/2, size/2, size/2 - 8, 0, Math.PI * 2); contestWheelCtx.fill();
                contestWheelCtx.fillStyle = '#999'; contestWheelCtx.font = '14px Arial'; contestWheelCtx.textAlign = 'center'; contestWheelCtx.fillText('Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†', size/2, size/2);
                return;
            }

            const anglePerSegment = (Math.PI * 2) / contestWheelNames.length;
            const startOffset = -Math.PI / 2;
            
            contestWheelNames.forEach((name, index) => {
                const startAngle = startOffset + (anglePerSegment * index);
                const endAngle = startAngle + anglePerSegment;
                
                contestWheelCtx.fillStyle = wheelColors[index % wheelColors.length];
                contestWheelCtx.beginPath(); contestWheelCtx.arc(size/2, size/2, size/2 - 8, startAngle, endAngle); contestWheelCtx.lineTo(size/2, size/2); contestWheelCtx.fill();
                
                contestWheelCtx.save();
                contestWheelCtx.translate(size/2, size/2);
                contestWheelCtx.rotate(startAngle + anglePerSegment / 2);
                contestWheelCtx.textAlign = 'right'; contestWheelCtx.fillStyle = '#ffffff'; contestWheelCtx.font = 'bold 14px Arial';
                contestWheelCtx.shadowColor = 'rgba(0,0,0,0.3)'; contestWheelCtx.shadowBlur = 3;
                contestWheelCtx.fillText(name.length > 10 ? name.substring(0, 10) + '...' : name, size/2 - 20, 5);
                contestWheelCtx.restore();
            });
        }
        
        function showContestWheelModal() {
            document.getElementById('contestWheelModal').classList.remove('hidden');
            const textarea = document.getElementById('contestNamesTextarea');
            const controlsDiv = document.getElementById('contestWheelControls');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø®Ø§ØµØ© (ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
            const isPrivateContest = currentEntityId && currentQuizData.quiz_type === 'competition';

            if (isPrivateContest) {
                // Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø§ØµØ©: ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØµÙ„ ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ
                controlsDiv.classList.add('hidden');
                
                if (currentClassId) {
                    const cls = allData.find(item => item.id === currentClassId);
                    const students = JSON.parse(cls.students || '[]');
                    contestWheelNames = students.map(s => s.name);
                    
                    if (contestWheelNames.length < 2) {
                        showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„ÙØµÙ„ Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø¬Ù„Ø©.', true);
                    }
                } else {
                    contestWheelNames = [];
                    showToast('Ù„Ù… ÙŠØªÙ… Ø¥Ø³Ù†Ø§Ø¯ ÙØµÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù….', true);
                }

            } else {
                // Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©: Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                controlsDiv.classList.remove('hidden');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¬Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø§ Ù‡Ùˆ Ù…ÙƒØªÙˆØ¨ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹
                updateContestWheelNames();
            }

            drawContestWheel();
            document.getElementById('contestWinnerDisplay').textContent = '';
            document.getElementById('contestSpinButton').disabled = contestWheelNames.length < 2 || contestIsSpinning;
        }
        
        function hideContestWheelModal() {
            document.getElementById('contestWheelModal').classList.add('hidden');
        }
        
        function spinContestWheel() {
            if (contestIsSpinning || contestWheelNames.length < 2) return;
            
            contestIsSpinning = true;
            const spinButton = document.getElementById('contestSpinButton');
            spinButton.disabled = true;
            spinButton.classList.add('spinning');
            
            contestWheelCanvas.style.transition = 'none';
            contestCurrentRotation = contestCurrentRotation % 360;
            contestWheelCanvas.style.transform = `rotate(${contestCurrentRotation}deg)`;
            void contestWheelCanvas.offsetWidth;
            
            const spins = 5 + Math.random() * 3;
            const extraDegrees = Math.random() * 360;
            const totalRotation = contestCurrentRotation + spins * 360 + extraDegrees;
            
            contestWheelCanvas.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
            contestWheelCanvas.style.transform = `rotate(${totalRotation}deg)`;
            
            contestCurrentRotation = totalRotation;

            document.getElementById('contestWinnerDisplay').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±...';

            setTimeout(() => {
                const finalRotation = contestCurrentRotation % 360;
                const anglePerSegment = 360 / contestWheelNames.length;
                let normalizedAngle = (360 - finalRotation) % 360; 
                if (normalizedAngle < 0) normalizedAngle += 360;

                const winnerIndex = Math.floor(normalizedAngle / anglePerSegment) % contestWheelNames.length;
                const winner = contestWheelNames[winnerIndex];

                document.getElementById('contestWinnerDisplay').innerHTML = `ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ: <strong>${winner}</strong>!`;
                createConfetti();

                contestIsSpinning = false;
                spinButton.classList.remove('spinning');
                spinButton.textContent = 'Ø§Ø®ØªÙŠØ§Ø± Ø¢Ø®Ø±';
                spinButton.disabled = false;
            }, 4000);
        }
        // ---- Ù†Ù‡Ø§ÙŠØ© Ø¯ÙˆØ§Ù„ Ø¹Ø¬Ù„Ø© Ø§Ù„Ø­Ø¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ----


        function showWinner(winner) {
            const modal = document.getElementById('winnerModal');
            const winnerName = document.getElementById('winnerName');
            currentWinner = winner;
            winnerName.textContent = winner;
            modal.classList.add('show');
        }

        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¯Ø§Ù„Ø© saveWinnerToDb Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Firebase
        
        function createConfetti() {
            const colors = ['#81c784', '#64b5f6', '#ffb74d', '#e57373', '#ba68c8', '#4db6ac', '#ff8a65', '#9575cd'];
            const confettiCount = 150;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = confetti.style.width;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 20);
            }
        }
        
        function normalizeArabicText(text) {
            if (!text) return '';
            return text
                .replace(/Ø£|Ø¥|Ø¢/g, 'Ø§')
                .replace(/Ø©/g, 'Øª')
                .replace(/[Ù‘Ù€Ù-Ù’]/g, '')
                .toLowerCase().trim();
        }

        function showCelebration(type, message, emoji) {
            const overlay = document.getElementById('celebration-overlay');
            const emojiEl = document.getElementById('celebration-emoji');
            const messageEl = document.getElementById('celebration-message');
            const closeBtn = document.getElementById('celebration-close');
            
            emojiEl.textContent = emoji;
            messageEl.textContent = message;
            
            messageEl.style.color = type === 'success' ? '#28a745' : type === 'close' ? '#ffc107' : '#dc3545';
            closeBtn.style.background = defaultConfig.primary_color || '#667eea'; 
            overlay.style.display = 'flex';
            
            if (type === 'success') { createConfetti(); }
            
            closeBtn.onclick = () => { overlay.style.display = 'none'; };
        }
        
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = getEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        function getEditDistance(str1, str2) {
            const costs = [];
            for (let i = 0; i <= str1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= str2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (str1.charAt(i - 1) !== str2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[str2.length] = lastValue;
            }
            return costs[str2.length];
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (isError) toast.classList.add('error');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.remove('error');
            }, 3000);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹ ---
        let currentCertImageBase64 = null;

        function showCertificateManagement() {
            const select = document.getElementById('certQuizSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø´Ù‡Ø§Ø¯ØªÙ‡Ø§ --</option>';
            
            const quizzes = allData.filter(item => item.type === 'quiz' && item.entity_id === currentEntityId);
            quizzes.forEach(q => {
                const option = document.createElement('option');
                option.value = q.id;
                option.textContent = q.quiz_title;
                select.appendChild(option);
            });
            
            document.getElementById('certSettingsArea').classList.add('hidden');
            showPage('certificateManagementPage');
        }

        function loadQuizCertSettings() {
            const quizId = document.getElementById('certQuizSelect').value;
            if (!quizId) {
                document.getElementById('certSettingsArea').classList.add('hidden');
                return;
            }
            
            const quiz = allData.find(item => item.id === quizId);
            if (quiz) {
                document.getElementById('certSettingsArea').classList.remove('hidden');
                document.getElementById('certTitleInput').value = quiz.cert_title || 'Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ…Ø§Ù…';
                document.getElementById('certBodyInput').value = quiz.cert_body || 'ØªØ´Ù‡Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø£Ù†';
                
                const preview = document.getElementById('certImagePreview');
                if (quiz.cert_bg) {
                    currentCertImageBase64 = quiz.cert_bg;
                    preview.innerHTML = `<img src="${quiz.cert_bg}" style="width:100%">`;
                } else {
                    currentCertImageBase64 = null;
                    preview.innerHTML = '';
                }
            }
        }

        function previewCertImage() {
            const file = document.getElementById('certBgInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentCertImageBase64 = e.target.result;
                    document.getElementById('certImagePreview').innerHTML = `<img src="${currentCertImageBase64}" style="width:100%">`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveCertSettings() {
            const quizId = document.getElementById('certQuizSelect').value;
            const quiz = allData.find(item => item.id === quizId);
            if (!quiz) return;

            // ØªØ­Ø¯ÙŠØ« ÙƒØ§Ø¦Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
            const updatedQuiz = {
                ...quiz,
                cert_title: document.getElementById('certTitleInput').value,
                cert_body: document.getElementById('certBodyInput').value,
                cert_bg: currentCertImageBase64 // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ù„Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø©
            };

            const result = await window.dataSdk.update(updatedQuiz);
            if (result.isOk) {
                showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. Ø±Ø¨Ù…Ø§ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹.', true);
            }
        }

        // ----------------------------------------------------------------------
        // ğŸ†• Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°Ø§ØªÙŠ (Enrollment)
        // ----------------------------------------------------------------------

        function updateEnrollmentCardVisibility() {
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            const cardContainer = document.getElementById('entityPageEnrollmentCard');
            
            if (!entity || !cardContainer) return;

            const enrollConfig = JSON.parse(entity.enrollment_config || '{}');
            
            if (enrollConfig.status === 'enabled' || enrollConfig.status === 'auto') {
                const requiredFields = [];
                if (enrollConfig.req_student_phone) requiredFields.push('Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨');
                if (enrollConfig.req_parent_phone) requiredFields.push('Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');

                const message = enrollConfig.status === 'auto' ? '(ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±ÙŠ)' : '(ÙŠØ­ØªØ§Ø¬ Ø§Ø¹ØªÙ…Ø§Ø¯)';
                
                cardContainer.innerHTML = `
                    <div class="main-card" onclick="showPage('studentEnrollmentFormPage')" style="cursor: pointer; background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%); color: white; margin-top: 20px;">
                        <h3 style="margin: 0;">âœï¸ ØªØ³Ø¬ÙŠÙ„ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ${message}</h3>
                        <p style="margin: 5px 0;">Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ: Ø§Ù„Ø§Ø³Ù… ${requiredFields.length > 0 ? 'ØŒ ' + requiredFields.join('ØŒ ') : ''})</p>
                    </div>
                `;
                // ØªØ­Ø¯ÙŠØ« Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
                updateEnrollmentForm(enrollConfig);
            } else {
                cardContainer.innerHTML = '';
            }
        }

        function updateEnrollmentForm(config) {
            if (!config) return;
            // Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø¦Ù…Ø§ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
            document.getElementById('enroll_name').required = true; 
            document.getElementById('enroll_student_phone').required = config.req_student_phone || false;
            document.getElementById('enroll_parent_phone').required = config.req_parent_phone || false;
            
            // Ø¥Ø¶Ø§ÙØ© Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±
            document.querySelector('#studentEnrollmentForm .form-group:nth-child(1) label').innerHTML = `Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„: <span style="color:red;">*</span>`;
            document.querySelector('#studentEnrollmentForm .form-group:nth-child(2) label').innerHTML = `Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨: ${config.req_student_phone ? '<span style="color:red;">*</span>' : ''}`;
            document.querySelector('#studentEnrollmentForm .form-group:nth-child(3) label').innerHTML = `Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${config.req_parent_phone ? '<span style="color:red;">*</span>' : ''}`;


            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('enroll_name').value = '';
            document.getElementById('enroll_student_phone').value = '';
            document.getElementById('enroll_parent_phone').value = '';
            document.getElementById('enrollmentStatusMessage').textContent = '';
        }


        async function submitStudentEnrollment(event) {
            event.preventDefault();
            const name = document.getElementById('enroll_name').value.trim();
            const studentPhone = document.getElementById('enroll_student_phone').value.trim();
            const parentPhone = document.getElementById('enroll_parent_phone').value.trim();
            const statusMsgEl = document.getElementById('enrollmentStatusMessage');

            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            const enrollConfig = JSON.parse(entity.enrollment_config || '{}');
            
            if (!name) return showToast('Ø§Ù„Ø§Ø³Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠ', true);
            
            const enrollmentType = enrollConfig.status;
            const isAutoEnroll = enrollmentType === 'auto';
            const defaultClassId = isAutoEnroll ? enrollConfig.default_class_id : null;

            if (isAutoEnroll && !defaultClassId) {
                return showToast('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: Ø§Ù„ÙØµÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ØºÙŠØ± Ù…Ø­Ø¯Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.', true);
            }

            const enrollmentData = {
                id: 'enroll_' + Date.now(),
                type: 'pending_enrollment',
                entity_id: currentEntityId,
                name: name,
                student_phone: studentPhone,
                parent_phone: parentPhone,
                status: enrollmentType === 'auto' ? 'accepted' : 'pending', 
                created_at: Date.now()
            };

            if (isAutoEnroll) {
                // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯
                const targetClass = allData.find(item => item.id === defaultClassId);
                if (targetClass) {
                    const students = JSON.parse(targetClass.students || '[]');
                    students.push({ 
                        id: 'std_' + enrollmentData.id, 
                        name: name, 
                        student_phone: studentPhone, 
                        parent_phone: parentPhone 
                    });

                    await window.dataSdk.update({ ...targetClass, students: JSON.stringify(students) });
                    
                    statusMsgEl.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!';
                    showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                     return showToast('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.', true);
                }
                
            } else {
                // 2. Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ…Ø¹Ù„Ù‚ (Pending)
                const result = await window.dataSdk.create(enrollmentData);
                if (result.isOk) {
                    statusMsgEl.textContent = 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.';
                    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    return showToast('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.', true);
                }
            }
            
            // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            document.getElementById('studentEnrollmentForm').reset();
        }

        // ----------------------------------------------------------------------
        // ğŸ†• Ø¯ÙˆØ§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
        // ----------------------------------------------------------------------

        function showEnrollmentSettings() {
            const select = document.getElementById('defaultClassSelect');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ÙØµÙ„Ø§Ù‹ --</option>';
            
            const classes = allData.filter(item => item.type === 'class' && item.entity_id === currentEntityId);
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                select.appendChild(option);
            });
            
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            const config = JSON.parse(entity.enrollment_config || '{}');
            
            document.getElementById('enrollmentStatus').value = config.status || 'disabled';
            document.getElementById('req_student_phone').checked = config.req_student_phone || false;
            document.getElementById('req_parent_phone').checked = config.req_parent_phone || false;
            
            if (config.default_class_id) {
                document.getElementById('defaultClassSelect').value = config.default_class_id;
            }
            
            showPage('enrollmentSettingsPage');
        }

        async function saveEnrollmentSettings() {
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            if (!entity) return;

            const status = document.getElementById('enrollmentStatus').value;
            const defaultClassId = document.getElementById('defaultClassSelect').value;
            
            if (status === 'auto' && !defaultClassId) {
                return showToast('Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠØŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙØµÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ.', true);
            }
            
            const newConfig = {
                status: status,
                req_name: true, // Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
                req_student_phone: document.getElementById('req_student_phone').checked,
                req_parent_phone: document.getElementById('req_parent_phone').checked,
                default_class_id: status === 'auto' ? defaultClassId : null
            };
            
            const updatedEntity = { ...entity, enrollment_config: JSON.stringify(newConfig) };
            const result = await window.dataSdk.update(updatedEntity);
            
            if (result.isOk) {
                showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
                updateEnrollmentCardVisibility(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙˆØ±Ø§Ù‹
            } else {
                showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', true);
            }
        }

        function updatePendingCount() {
            const pendingRequests = allData.filter(item => 
                item.type === 'pending_enrollment' && 
                item.entity_id === currentEntityId &&
                item.status === 'pending'
            );
            const countElement = document.getElementById('pendingCount');
            if (countElement) {
                countElement.textContent = pendingRequests.length;
                if (pendingRequests.length > 0) {
                    countElement.parentElement.classList.remove('btn-warning');
                    countElement.parentElement.classList.add('btn-danger');
                } else {
                    countElement.parentElement.classList.remove('btn-danger');
                    countElement.parentElement.classList.add('btn-warning');
                }
            }
        }


        function showPendingEnrollments() {
            const pendingList = allData.filter(item => 
                item.type === 'pending_enrollment' && 
                item.entity_id === currentEntityId &&
                item.status === 'pending'
            ).sort((a, b) => b.created_at - a.created_at);

            const classes = allData.filter(item => item.type === 'class' && item.entity_id === currentEntityId);
            const classOptions = classes.map(cls => 
                `<option value="${cls.id}">${cls.name}</option>`
            ).join('');

            const container = document.getElementById('pendingEnrollmentList');
            
            if (pendingList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                showPage('pendingEnrollmentsPage');
                return;
            }

            container.innerHTML = pendingList.map(request => `
                <div class="entity-card" style="border-right: 5px solid #ffc107;">
                    <h4 style="margin: 0; display: flex; justify-content: space-between;">
                        <span>ğŸ‘¤ ${request.name}</span>
                        <span style="font-size: 0.8em; color: #999;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: ${new Date(request.created_at).toLocaleDateString('ar-SA')}</span>
                    </h4>
                    <p style="margin: 5px 0; font-size: 0.9em;">
                        <strong>Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${request.student_phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} | 
                        <strong>Ù‡Ø§ØªÙ Ø§Ù„ÙˆÙ„ÙŠ:</strong> ${request.parent_phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                    </p>
                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                        <select id="classSelect_${request.id}" style="flex: 2; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">-- Ø§Ø®ØªØ± ÙØµÙ„Ø§Ù‹ Ù„Ù„Ø¥Ø¶Ø§ÙØ© --</option>
                            ${classOptions}
                        </select>
                        <button class="btn btn-success" style="flex: 1; padding: 8px 15px;" onclick="acceptEnrollment('${request.__backendId}', '${request.id}')">Ù‚Ø¨ÙˆÙ„</button>
                        <button class="btn btn-danger" style="flex: 1; padding: 8px 15px; background: #6c757d;" onclick="rejectEnrollment('${request.__backendId}')">Ø±ÙØ¶</button>
                    </div>
                </div>
            `).join('');

            showPage('pendingEnrollmentsPage');
        }

        async function acceptEnrollment(backendId, enrollmentId) {
            const classId = document.getElementById(`classSelect_${enrollmentId}`).value;
            if (!classId) {
                return showToast('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„ÙŠÙ‡.', true);
            }
            
            const enrollmentRecord = allData.find(item => item.__backendId === backendId);
            const targetClass = allData.find(item => item.id === classId);

            if (!enrollmentRecord || !targetClass) {
                return showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.', true);
            }

            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„
            const students = JSON.parse(targetClass.students || '[]');
            students.push({
                id: 'std_' + enrollmentRecord.id, // Ø§Ø³ØªØ®Ø¯Ø§Ù… id Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¬Ø²Ø¡ Ù…Ù† id Ø§Ù„Ø·Ø§Ù„Ø¨
                name: enrollmentRecord.name,
                student_phone: enrollmentRecord.student_phone,
                parent_phone: enrollmentRecord.parent_phone
            });

            const updateClassResult = await window.dataSdk.update({ ...targetClass, students: JSON.stringify(students) });
            
            if (updateClassResult.isOk) {
                // 2. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ 'accepted' (ÙˆØ­Ø°ÙÙ‡ Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø©)
                const deleteRequestResult = await window.dataSdk.delete(enrollmentRecord); 
                
                showToast(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ${enrollmentRecord.name} ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­!`);
            } else {
                showToast('ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØµÙ„.', true);
            }
        }

        async function rejectEnrollment(backendId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) return;
            
            const enrollmentRecord = allData.find(item => item.__backendId === backendId);
            if (!enrollmentRecord) return;
            
            const result = await window.dataSdk.delete(enrollmentRecord);
            
            if (result.isOk) {
                showToast('ØªÙ… Ø±ÙØ¶ ÙˆØ­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
            } else {
                showToast('ÙØ´Ù„ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.', true);
            }
        }
        // ----------------------------------------------------------------------


        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹ ---
        let currentClassId = null;

        function showClassesManagement() {
            renderClassesList();
            showPage('classesManagementPage');
        }

        async function createNewClass() {
            const name = document.getElementById('newClassName').value;
            if (!name) return showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„', true);
            
            if (allData.length >= 999) return showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø¬Ù„Ø§Øª', true);

            const result = await window.dataSdk.create({
                id: 'class_' + Date.now(),
                type: 'class',
                entity_id: currentEntityId,
                name: name,
                assigned_member_id: '', // ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                students: JSON.stringify([]) // Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© Ù„Ù„Ø·Ù„Ø§Ø¨
            });

            if (result.isOk) {
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„');
                document.getElementById('newClassName').value = '';
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', true);
            }
        }

        function renderClassesList() {
            const container = document.getElementById('classesList');
            const classes = allData.filter(item => item.type === 'class' && item.entity_id === currentEntityId);
            
            // Ø¬Ù„Ø¨ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ù‡Ø© Ù„Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            const members = JSON.parse(entity.members || '[]');

            if (classes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„</p>';
                return;
            }

            container.innerHTML = classes.map(cls => {
                const students = JSON.parse(cls.students || '[]');
                const assignedMember = members.find(m => m.id === cls.assigned_member_id);
                const memberName = assignedMember ? assignedMember.username : 'ØºÙŠØ± Ù…Ø³Ù†Ø¯';

                // Ø¥Ù†Ø´Ø§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡
                const membersOptions = members.map(m => 
                    `<option value="${m.id}" ${cls.assigned_member_id === m.id ? 'selected' : ''}>${m.username}</option>`
                ).join('');

                return `
                <div class="quiz-item" style="border-right-color: #f5576c;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4 style="margin:0;">${cls.name}</h4>
                        <span style="font-size:0.8em; background:#eee; padding:2px 8px; border-radius:4px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${students.length}</span>
                    </div>
                    
                    <div style="margin: 10px 0; display: flex; align-items: center; gap: 5px;">
                        <label style="font-size: 0.9em;">Ø¥Ø³Ù†Ø§Ø¯ Ø¥Ù„Ù‰ Ù…Ø¹Ù„Ù…: (${memberName})</label>
                        <select onchange="assignClassMember('${cls.__backendId}', this.value)" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">-- Ø§Ø®ØªØ± Ø¹Ø¶ÙˆØ§Ù‹ --</option>
                            ${membersOptions}
                        </select>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn" onclick="openClassDetails('${cls.id}')" style="flex: 2; padding: 5px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                        <button class="btn btn-secondary" onclick="openAttendanceHistory('${cls.id}')" style="flex: 2; padding: 5px;">Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</button>
                        <button class="btn btn-danger" onclick="deleteClass('${cls.__backendId}')" style="flex: 1; padding: 5px;">Ø­Ø°Ù</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function assignClassMember(classBackendId, memberId) {
            const cls = allData.find(item => item.__backendId === classBackendId);
            if (!cls) return;
            
            const updatedClass = { ...cls, assigned_member_id: memberId };
            const result = await window.dataSdk.update(updatedClass);
            if (result.isOk) showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„ÙØµÙ„');
            else showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', true);
        }

        async function deleteClass(backendId) {
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¯Ø§Ø®Ù„Ù‡.')) return;
            const cls = allData.find(item => item.__backendId === backendId);
            if(cls) await window.dataSdk.delete(cls);
        }
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ² ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ù…Ø«Ø§Ù„: +966) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            phone = phone.replace(/[^\d+]/g, '');
            if (!phone.startsWith('+')) {
                // Ø§ÙØªØ±Ø§Ø¶ Ø±Ù‚Ù… Ø³Ø¹ÙˆØ¯ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (phone.startsWith('0')) {
                    phone = phone.substring(1); 
                }
                phone = '966' + phone; // Ù†Ø±Ø³Ù„ 966 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† +966 ÙÙŠ Ø±Ø§Ø¨Ø· wa.me
            } else {
                 phone = phone.substring(1); // Ø¥Ø²Ø§Ù„Ø© + Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            }
            return phone;
        }

        // --- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ ---
        function openClassDetails(classId) {
            currentClassId = classId;
            const cls = allData.find(item => item.id === classId);
            if (!cls) return;

            document.getElementById('currentClassName').textContent = cls.name;
            
            const entity = allData.find(item => item.type === 'entity' && item.id === currentEntityId);
            const members = JSON.parse(entity.members || '[]');
            const teacher = members.find(m => m.id === cls.assigned_member_id);
            document.getElementById('classTeacherName').textContent = teacher ? `Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${teacher.username}` : 'Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ù„Ù…';

            renderStudentsList();
            showPage('classDetailsPage');
        }

        function renderStudentsList() {
            const cls = allData.find(item => item.id === currentClassId);
            if (!cls) return;
            const students = JSON.parse(cls.students || '[]');
            const container = document.getElementById('studentsList');
            
            // Ø¬Ù„Ø¨ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙØµÙˆÙ„ Ù„ØºØ±Ø¶ Ø§Ù„Ù†Ù‚Ù„
            const otherClasses = allData.filter(item => item.type === 'class' && item.entity_id === currentEntityId && item.id !== currentClassId);

            if (students.length === 0) {
                container.innerHTML = '<p style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>';
                return;
            }

            container.innerHTML = students.map((std, index) => {
                const moveOptions = otherClasses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                const moveSelect = otherClasses.length > 0 ? `
                    <select onchange="moveStudent('${std.id}', this.value)" style="padding: 5px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Ù†Ù‚Ù„ Ø¥Ù„Ù‰...</option>
                        ${moveOptions}
                    </select>
                ` : '';

                const studentPhone = std.student_phone || '';
                const parentPhone = std.parent_phone || '';
                
                return `
                <div class="member-item" style="flex-direction: column; align-items: stretch; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap;">
                        <strong style="font-size: 1.1em;">${std.name}</strong>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                            ${moveSelect}
                            <button class="btn btn-secondary" style="width: auto; padding: 5px 10px;" onclick="openEditStudentModal('${std.id}', '${std.name}', '${studentPhone}', '${parentPhone}')">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn btn-danger" style="width: auto; padding: 5px 10px;" onclick="removeStudent('${std.id}')">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <span style="color: #666;">Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨:</span> 
                            <span style="font-weight: bold;">${studentPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span>
                            ${studentPhone ? `<a href="https://wa.me/${formatPhoneForWhatsApp(studentPhone)}" target="_blank" class="btn" style="padding: 5px 10px; width: auto; margin-right: 10px; background: #25D366; display: inline-block;">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>` : ''}
                        </div>
                        <div>
                            <span style="color: #666;">Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span> 
                            <span style="font-weight: bold;">${parentPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span>
                            ${parentPhone ? `<a href="https://wa.me/${formatPhoneForWhatsApp(parentPhone)}" target="_blank" class="btn" style="padding: 5px 10px; width: auto; margin-right: 10px; background: #25D366; display: inline-block;">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>` : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function openEditStudentModal(studentId, name, studentPhone, parentPhone) {
             const modal = document.createElement('div');
             modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center;';
             
             modal.innerHTML = `
                 <div class="main-card" style="max-width: 450px; padding: 30px;">
                     <h3 class="section-title" style="margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}</h3>
                     
                     <div class="form-group">
                         <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                         <input type="text" id="editStdName" value="${name}">
                     </div>
                     <div class="form-group">
                         <label>Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                         <input type="text" id="editStdPhone" value="${studentPhone}">
                     </div>
                     <div class="form-group">
                         <label>Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                         <input type="text" id="editParentPhone" value="${parentPhone}">
                     </div>
                     
                     <div style="display: flex; gap: 10px; margin-top: 20px;">
                         <button class="btn btn-success" style="flex: 1;" onclick="saveEditedStudent('${studentId}')">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                         <button class="btn btn-secondary" style="flex: 1;" onclick="this.closest('.main-card').parentElement.remove()">Ø¥Ù„ØºØ§Ø¡</button>
                     </div>
                 </div>
             `;
             document.body.appendChild(modal);
        }
        
        async function saveEditedStudent(studentId) {
            const newName = document.getElementById('editStdName').value.trim();
            const newStdPhone = document.getElementById('editStdPhone').value.trim();
            const newParentPhone = document.getElementById('editParentPhone').value.trim();

            if (!newName) {
                return showToast('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            }
            
            const cls = allData.find(item => item.id === currentClassId);
            let students = JSON.parse(cls.students || '[]');
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex !== -1) {
                students[studentIndex] = {
                    ...students[studentIndex],
                    name: newName,
                    student_phone: newStdPhone,
                    parent_phone: newParentPhone
                };
            }

            const result = await window.dataSdk.update({ ...cls, students: JSON.stringify(students) });
            if (result.isOk) {
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
                document.querySelector('.main-card').parentElement.remove();
                
                // *** ğŸ†• ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Attendance Records) ***
                const attendanceRecords = allData.filter(item => 
                    item.type === 'attendance' && 
                    item.class_id === currentClassId
                );

                for (const record of attendanceRecords) {
                    let states = JSON.parse(record.states);
                    const stateIndex = states.findIndex(s => s.id === studentId);
                    
                    if (stateIndex !== -1) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                        states[stateIndex].name = newName;
                        
                        await window.dataSdk.update({
                            ...record,
                            states: JSON.stringify(states)
                        });
                    }
                }

            } else {
                showToast('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            }
        }


        async function addStudentToClass() {
            const name = document.getElementById('newStudentName').value;
            const studentPhone = document.getElementById('newStudentPhone').value.trim();
            const parentPhone = document.getElementById('newParentPhone').value.trim();

            if (!name) return showToast('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            
            const cls = allData.find(item => item.id === currentClassId);
            const students = JSON.parse(cls.students || '[]');
            students.push({ id: 'std_' + Date.now(), name: name, student_phone: studentPhone, parent_phone: parentPhone });
            
            const result = await window.dataSdk.update({ ...cls, students: JSON.stringify(students) });
            if (result.isOk) {
                document.getElementById('newStudentName').value = '';
                document.getElementById('newStudentPhone').value = '';
                document.getElementById('newParentPhone').value = '';
                showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨');
                // renderStudentsList() Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© onDataChanged
            } else {
                showToast('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            }
        }

        async function removeStudent(studentId) {
            const cls = allData.find(item => item.id === currentClassId);
            const students = JSON.parse(cls.students || '[]');
            const updatedStudents = students.filter(std => std.id !== studentId);

            const result = await window.dataSdk.update({ ...cls, students: JSON.stringify(updatedStudents) });
            if (result.isOk) {
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨');
            } else {
                showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            }
        }

        async function moveStudent(studentId, targetClassId) {
            if (!targetClassId) return;

            const sourceClass = allData.find(item => item.id === currentClassId);
            const targetClass = allData.find(item => item.id === targetClassId);
            
            if (!sourceClass || !targetClass) return;

            const sourceStudents = JSON.parse(sourceClass.students || '[]');
            const targetStudents = JSON.parse(targetClass.students || '[]');
            
            // Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ù‚Ù„Ù‡
            const studentToMove = sourceStudents.find(std => std.id === studentId);
            
            if (!studentToMove) return;

            // Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±
            const updatedSourceStudents = sourceStudents.filter(std => std.id !== studentId);
            
            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‡Ø¯Ù
            targetStudents.push(studentToMove);
            
            // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø¯ÙŠØ« (ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«ÙŠÙ‚ØªÙŠÙ†)
            const sourceResult = await window.dataSdk.update({ ...sourceClass, students: JSON.stringify(updatedSourceStudents) });
            const targetResult = await window.dataSdk.update({ ...targetClass, students: JSON.stringify(targetStudents) });

            if (sourceResult.isOk && targetResult.isOk) {
                showToast(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentToMove.name} Ø¥Ù„Ù‰ ÙØµÙ„ ${targetClass.name} Ø¨Ù†Ø¬Ø§Ø­`);
            } else {
                 showToast('ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨', true);
            }
        }

        // --- Ø³Ø¬Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… (Attendance History) ---
        function openAttendanceHistory() {
            if (!currentClassId) return showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØµÙ„ Ù…Ø³Ù†Ø¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„.', true);
            renderAttendanceHistory(currentClassId);
            showPage('attendanceHistoryPage');
        }
        
        function renderAttendanceHistory(classId) {
            const cls = allData.find(item => item.id === classId);
            if (!cls) return;

            document.getElementById('historyClassName').textContent = `Ø§Ù„ÙØµÙ„: ${cls.name}`;
            document.getElementById('historyClassName').dataset.classId = classId;

            const allRecords = allData.filter(item => 
                item.type === 'attendance' && 
                item.class_id === classId
            );

            if (allRecords.length === 0) {
                document.getElementById('attendanceSummary').innerHTML = '<h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯.</h4>';
                document.getElementById('attendanceRecordsList').innerHTML = '';
                return;
            }

            const studentNames = JSON.parse(cls.students || '[]').map(s => s.name);
            const attendanceSummary = {};

            // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            allRecords.forEach(record => {
                const states = JSON.parse(record.states);
                states.forEach(student => {
                    if (!attendanceSummary[student.name]) {
                        attendanceSummary[student.name] = { total: 0, Ø­Ø§Ø¶Ø±: 0, ØºØ§Ø¦Ø¨: 0, Ù…ØªØ£Ø®Ø±: 0, Ø¨Ø¹Ø°Ø±: 0 };
                    }
                    attendanceSummary[student.name].total++;
                    attendanceSummary[student.name][student.status] = (attendanceSummary[student.name][student.status] || 0) + 1;
                });
            });

            // 2. Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            let summaryHtml = `
                <h5 style="margin-top: 0;">Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠ:</h5>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            `;
            
            Object.keys(attendanceSummary).forEach(name => {
                const data = attendanceSummary[name];
                const attendanceRate = ((data.Ø­Ø§Ø¶Ø± / data.total) * 100).toFixed(1);
                const color = attendanceRate < 70 ? '#dc3545' : attendanceRate < 90 ? '#ffc107' : '#28a745';
                
                summaryHtml += `
                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <strong style="color: #333;">${name}:</strong>
                        <span style="float: left; font-weight: bold; color: ${color};">${attendanceRate}%</span>
                        <p style="font-size: 0.8em; margin: 5px 0;">Ø­Ø¶ÙˆØ±: ${data.Ø­Ø§Ø¶Ø±} | ØºÙŠØ§Ø¨: ${data.ØºØ§Ø¦Ø¨} | ØªØ£Ø®ÙŠØ±: ${data.Ù…ØªØ£Ø®Ø±}</p>
                    </div>
                `;
            });

            summaryHtml += `</div>`;
            document.getElementById('attendanceSummary').innerHTML = summaryHtml;

            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            allRecords.sort((a, b) => new Date(b.date) - new Date(a.date)); // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®

            let recordsHtml = allRecords.map(record => {
                const states = JSON.parse(record.states);
                let detailHtml = states.map(s => {
                    let statusColor = s.status === 'ØºØ§Ø¦Ø¨' ? '#dc3545' : s.status === 'Ù…ØªØ£Ø®Ø±' ? '#ffc107' : '#28a745';
                    return `<span style="font-size: 0.9em; margin-left: 15px;">${s.name}: <strong style="color: ${statusColor};">${s.status}</strong></span>`;
                }).join('');
                
                return `
                    <div class="quiz-item" style="border-right-color: #667eea; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">ğŸ—“ï¸ Ø³Ø¬Ù„ ÙŠÙˆÙ…: ${record.date}</h4>
                        <div style="margin-top: 10px; display: flex; flex-wrap: wrap;">
                            ${detailHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('attendanceRecordsList').innerHTML = recordsHtml;
        }

        // --- Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙ„ Ù„Ù„Ù…Ø¹Ù„Ù… ---
        function showTeacherClass(classId) {
            const cls = allData.find(item => item.id === classId);
            if (!cls) return;
            
            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØºØ±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            currentClassId = cls.id;

            document.getElementById('teacherClassName').textContent = cls.name;
            const students = JSON.parse(cls.students || '[]');
            document.getElementById('teacherStudentCount').textContent = students.length;

            const list = document.getElementById('teacherStudentsList');

            if (students.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ ÙØµÙ„Ùƒ.</p>';
            } else {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© renderAttendanceTable Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                renderAttendanceTable(cls, students);
            }
            showPage('teacherClassViewPage');
        }
        
        // --- Ø¯ÙˆØ§Ù„ Ø¢Ù„ÙŠØ© Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---

        /**
         * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨
         * @param {object} student - ÙƒØ§Ø¦Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙ„
         * @param {string} status - Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ('Ø­Ø§Ø¶Ø±', 'ØºØ§Ø¦Ø¨', 'Ù…ØªØ£Ø®Ø±', 'Ø¨Ø¹Ø°Ø±')
         */
        function createAttendanceRow(student, status = 'Ø­Ø§Ø¶Ø±') {
            const statuses = ['Ø­Ø§Ø¶Ø±', 'ØºØ§Ø¦Ø¨', 'Ù…ØªØ£Ø®Ø±', 'Ø¨Ø¹Ø°Ø±'];
            
            let optionsHtml = statuses.map(s => `
                <option value="${s}" ${s === status ? 'selected' : ''}>${s}</option>
            `).join('');

            const studentPhone = student.student_phone || '';
            const parentPhone = student.parent_phone || '';

            return `
                <div class="member-item" data-student-id="${student.id}" data-student-name="${student.name}" style="flex-direction: row; justify-content: space-between; align-items: center; padding: 15px;">
                    <strong style="flex-basis: 25%;">${student.name}</strong>
                    <div style="flex-basis: 30%; text-align: right; font-size: 0.9em; color: #666;">
                        Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                        <br>
                        ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${parentPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
                    </div>
                    <select class="attendance-status-select" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; flex-basis: 20%; margin-right: 15px;">
                        ${optionsHtml}
                    </select>
                    <div style="flex-basis: 25%; text-align: left;">
                        ${parentPhone ? `<a href="https://wa.me/${formatPhoneForWhatsApp(parentPhone)}?text=Ù†ÙˆØ¯ Ø¥Ø¨Ù„Ø§ØºÙƒÙ… Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name} Ø¹Ù† Ø­ØµØ© Ø§Ù„ÙŠÙˆÙ…." target="_blank" class="btn" style="padding: 5px 10px; width: auto; background: #25D366; display: inline-block; font-size: 0.8em; margin-right: 5px;">ğŸ“± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</a>` : ''}
                         ${studentPhone ? `<a href="https://wa.me/${formatPhoneForWhatsApp(studentPhone)}?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${student.name}ØŒ Ù†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ¹Ø¯." target="_blank" class="btn" style="padding: 5px 10px; width: auto; background: #25D366; display: inline-block; font-size: 0.8em;">ğŸ“± Ø§Ù„Ø·Ø§Ù„Ø¨</a>` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù…Ø¹Ù„Ù…
         * @param {object} cls - ÙƒØ§Ø¦Ù† Ø§Ù„ÙØµÙ„
         * @param {array} students - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
         */
        function renderAttendanceTable(cls, students) {
            const list = document.getElementById('teacherStudentsList');
            const todayDate = new Date().toISOString().slice(0, 10);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            const existingRecord = allData.find(item => 
                item.type === 'attendance' && 
                item.class_id === cls.id && 
                item.date === todayDate
            );

            let initialRowsHtml = '';
            let statusMessage = '';

            if (existingRecord) {
                const studentStates = JSON.parse(existingRecord.states);
                initialRowsHtml = students.map(student => {
                    const state = studentStates.find(s => s.id === student.id);
                    return createAttendanceRow(student, state ? state.status : 'Ø­Ø§Ø¶Ø±');
                }).join('');
                statusMessage = `<p style="color: #28a745; font-weight: bold; margin-bottom: 15px;">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (${todayDate}). ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.</p>`;
            } else {
                initialRowsHtml = students.map(student => createAttendanceRow(student)).join('');
                statusMessage = `<p style="color: #ffc107; font-weight: bold; margin-bottom: 15px;">âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… (${todayDate}). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­ÙØ¸.</p>`;
            }

            list.innerHTML = `
                <h4 style="margin-top: 10px;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…: ${todayDate}</h4>
                ${statusMessage}
                <div id="attendanceRowsContainer" style="max-height: 400px; overflow-y: auto;">
                    ${initialRowsHtml}
                </div>
                <button class="btn btn-success" style="margin-top: 20px;" onclick="saveAttendance('${cls.id}')">
                    ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±
                </button>
            `;
        }

        /**
         * Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙÙŠ Firebase
         * @param {string} classId - Ù…Ø¹Ø±Ù Ø§Ù„ÙØµÙ„
         */
        async function saveAttendance(classId) {
            const cls = allData.find(item => item.id === classId);
            if (!cls) return;

            const todayDate = new Date().toISOString().slice(0, 10);
            const rows = document.querySelectorAll('#attendanceRowsContainer .member-item');
            
            const studentStates = Array.from(rows).map(row => {
                return {
                    id: row.dataset.studentId,
                    name: row.dataset.studentName,
                    status: row.querySelector('.attendance-status-select').value
                };
            });

            const existingRecord = allData.find(item => 
                item.type === 'attendance' && 
                item.class_id === classId && 
                item.date === todayDate
            );

            const dataToSave = {
                class_id: classId,
                class_name: cls.name,
                entity_id: currentEntityId,
                date: todayDate,
                states: JSON.stringify(studentStates)
            };

            let result;
            if (existingRecord) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
                result = await window.dataSdk.update({ ...dataToSave, __backendId: existingRecord.__backendId });
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
                if (allData.length >= 999) return showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø¬Ù„Ø§Øª', true);
                result = await window.dataSdk.create({ ...dataToSave, type: 'attendance', id: 'att_' + Date.now() });
            }

            if (result.isOk) {
                showToast('ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
            } else {
                showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±.', true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
 </body>
</html>